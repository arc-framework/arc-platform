import{_ as s,C as r,o as i,c as t,an as o,b as d,w as l,a,E as n,ao as m}from"./chunks/framework.CTqRDTHW.js";const b=JSON.parse('{"title":"Tasks: Realtime Voice Infrastructure Setup","description":"","frontmatter":{},"headers":[],"relativePath":"007-voice-stack/tasks.md","filePath":"007-voice-stack/tasks.md","lastUpdated":1772310733000}'),p={name:"007-voice-stack/tasks.md"};function u(h,e,g,k,v,f){const c=r("Mermaid");return i(),t("div",null,[e[1]||(e[1]=o(`<h1 id="tasks-realtime-voice-infrastructure-setup" tabindex="-1">Tasks: Realtime Voice Infrastructure Setup <a class="header-anchor" href="#tasks-realtime-voice-infrastructure-setup" aria-label="Permalink to &quot;Tasks: Realtime Voice Infrastructure Setup&quot;">​</a></h1><blockquote><p><strong>Spec</strong>: 007-voice-stack <strong>Date</strong>: 2026-03-01</p></blockquote><h2 id="task-format" tabindex="-1">Task Format <a class="header-anchor" href="#task-format" aria-label="Permalink to &quot;Task Format&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>[TASK-NNN] [P?] [MODULE] [PRIORITY] Description</span></span>
<span class="line"><span>  Dependencies: [TASK-XXX] or none</span></span>
<span class="line"><span>  Module: services/{role}</span></span>
<span class="line"><span>  Acceptance: Testable criteria</span></span>
<span class="line"><span>  Status: [ ] pending | [~] in-progress | [x] done</span></span></code></pre></div><ul><li><code>[P]</code> = Safe for parallel agent execution</li><li>Priority: P1 (must), P2 (should), P3 (nice)</li></ul><h2 id="dependency-graph" tabindex="-1">Dependency Graph <a class="header-anchor" href="#dependency-graph" aria-label="Permalink to &quot;Dependency Graph&quot;">​</a></h2>`,6)),(i(),d(m,null,{default:l(()=>[n(c,{id:"mermaid-27",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20T001%5B%22TASK-001%5Cnprofiles.yaml%22%5D%20--%3E%20T011%0A%20%20%20%20T001%20--%3E%20T012%0A%20%20%20%20T001%20--%3E%20T013%0A%20%20%20%20T001%20--%3E%20T014%0A%20%20%20%20T001%20--%3E%20T015%0A%0A%20%20%20%20T011%5B%22TASK-011%20%5BP%5D%5CnDockerfile%5Cnarc-realtime%22%5D%0A%20%20%20%20T012%5B%22TASK-012%20%5BP%5D%5CnDockerfile.ingress%5Cnarc-realtime-ingress%22%5D%0A%20%20%20%20T013%5B%22TASK-013%20%5BP%5D%5CnDockerfile.egress%5Cnarc-realtime-egress%22%5D%0A%20%20%20%20T014%5B%22TASK-014%20%5BP%5D%5CnConfig%20YAMLs%5Cnlivekit%20%2F%20ingress%20%2F%20egress%22%5D%0A%20%20%20%20T015%5B%22TASK-015%20%5BP%5D%5Cnservice.yaml%22%5D%0A%0A%20%20%20%20T011%20--%3E%20T021%0A%20%20%20%20T012%20--%3E%20T021%0A%20%20%20%20T013%20--%3E%20T021%0A%20%20%20%20T014%20--%3E%20T021%0A%20%20%20%20T015%20--%3E%20T021%0A%0A%20%20%20%20T021%5B%22TASK-021%20%5BP%5D%5Cndocker-compose.yml%5Cn(all%203%20services)%22%5D%20--%3E%20T031%0A%20%20%20%20T021%20--%3E%20T022%0A%0A%20%20%20%20T022%5B%22TASK-022%20%5BP%5D%5Cnrealtime.mk%22%5D%20--%3E%20T031%0A%0A%20%20%20%20T031%5B%22TASK-031%5CnMakefile%20include%5Cn%2B%20scripts%20updates%22%5D%20--%3E%20T041%0A%20%20%20%20T031%20--%3E%20T042%0A%0A%20%20%20%20T041%5B%22TASK-041%20%5BP%5D%5Cnrealtime-images.yml%22%5D%20--%3E%20T051%0A%20%20%20%20T042%5B%22TASK-042%20%5BP%5D%5Cnrealtime-release.yml%22%5D%20--%3E%20T051%0A%0A%20%20%20%20T051%5B%22TASK-051%5CnE2E%20verification%22%5D%20--%3E%20T900%0A%20%20%20%20T051%20--%3E%20T999%0A%0A%20%20%20%20T900%5B%22TASK-900%5CnDocs%20%26%20links%22%5D%20--%3E%20T999%0A%20%20%20%20T999%5B%22TASK-999%5CnReviewer%22%5D%0A"})]),fallback:l(()=>[...e[0]||(e[0]=[a(" Loading... ",-1)])]),_:1})),e[2]||(e[2]=o(`<h2 id="quality-requirements" tabindex="-1">Quality Requirements <a class="header-anchor" href="#quality-requirements" aria-label="Permalink to &quot;Quality Requirements&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Module</th><th>Coverage</th><th>Lint</th><th>Notes</th></tr></thead><tbody><tr><td>Config/YAML</td><td>n/a</td><td><code>docker compose config</code> (no syntax errors)</td><td></td></tr><tr><td>Makefile</td><td>n/a</td><td><code>make -n {target}</code> dry-run passes</td><td></td></tr><tr><td>CI/CD YAML</td><td>n/a</td><td><code>python3 -c &quot;import yaml; yaml.safe_load(open(...))&quot;</code> exits 0</td><td></td></tr></tbody></table><hr><h2 id="phase-1-setup" tabindex="-1">Phase 1: Setup <a class="header-anchor" href="#phase-1-setup" aria-label="Permalink to &quot;Phase 1: Setup&quot;">​</a></h2><ul><li>[x] [TASK-001] [SERVICES] [P1] Update <code>services/profiles.yaml</code> — add <code>realtime</code> to <code>think</code> and <code>reason</code><ul><li>Dependencies: none</li><li>Module: <code>services/profiles.yaml</code></li><li>Acceptance: <ul><li>Python YAML validation confirms structure:<div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>python3 -c &quot;</span></span>
<span class="line"><span>import yaml</span></span>
<span class="line"><span>p = yaml.safe_load(open(&#39;services/profiles.yaml&#39;))</span></span>
<span class="line"><span>assert &#39;realtime&#39; in p[&#39;think&#39;][&#39;services&#39;], &#39;realtime missing from think&#39;</span></span>
<span class="line"><span>assert &#39;realtime&#39; in p[&#39;reason&#39;][&#39;services&#39;], &#39;realtime missing from reason&#39;</span></span>
<span class="line"><span>assert p[&#39;ultra-instinct&#39;][&#39;services&#39;] == &#39;*&#39;, &#39;ultra-instinct changed&#39;</span></span>
<span class="line"><span>print(&#39;profiles.yaml OK&#39;)</span></span>
<span class="line"><span>&quot;</span></span></code></pre></div></li><li><code>ultra-instinct</code> remains <code>&#39;*&#39;</code> (unchanged — wildcard already includes realtime)</li><li>All existing entries in <code>think</code> and <code>reason</code> preserved (no accidental removal)</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-2-core-files-fully-parallel" tabindex="-1">Phase 2: Core Files (fully parallel) <a class="header-anchor" href="#phase-2-core-files-fully-parallel" aria-label="Permalink to &quot;Phase 2: Core Files (fully parallel)&quot;">​</a></h2><p>All five tasks are independent — different files in the same directory. Run concurrently.</p><ul><li><p>[x] [TASK-011] [P] [SERVICES] [P1] Create <code>services/realtime/Dockerfile</code> — arc-realtime (LiveKit Server)</p><ul><li>Dependencies: TASK-001</li><li>Module: <code>services/realtime/Dockerfile</code></li><li>Acceptance: <ul><li><code>FROM livekit/livekit-server</code></li><li>OCI labels: <code>org.opencontainers.image.title</code>, <code>org.opencontainers.image.description</code>, <code>org.opencontainers.image.source=https://github.com/arc-framework/arc-platform</code></li><li>Arc service labels: <code>arc.service.name=arc-realtime</code>, <code>arc.service.codename=daredevil</code>, <code>arc.service.tech=livekit</code>, <code>arc.service.role=realtime</code></li><li>Run <code>docker run --rm --entrypoint id livekit/livekit-server</code> to verify user: <ul><li>If non-root → add <code>USER</code> directive for explicit declaration</li><li>If root → add comment: <code># livekit/livekit-server runs as root by default. This is a DEVELOPMENT-ONLY service. For production: build with non-root user.</code></li></ul></li><li><code>docker build -f services/realtime/Dockerfile services/realtime/</code> succeeds locally</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-012] [P] [SERVICES] [P1] Create <code>services/realtime/Dockerfile.ingress</code> — arc-realtime-ingress (LK Ingress)</p><ul><li>Dependencies: TASK-001</li><li>Module: <code>services/realtime/Dockerfile.ingress</code></li><li>Acceptance: <ul><li><code>FROM livekit/ingress</code></li><li>OCI labels: <code>org.opencontainers.image.title</code>, <code>org.opencontainers.image.description</code>, <code>org.opencontainers.image.source</code></li><li>Arc service labels: <code>arc.service.name=arc-realtime-ingress</code>, <code>arc.service.codename=sentry</code>, <code>arc.service.tech=livekit-ingress</code>, <code>arc.service.role=realtime-ingress</code></li><li>Non-root handling: same verify-and-document pattern as TASK-011</li><li><code>docker build -f services/realtime/Dockerfile.ingress services/realtime/</code> succeeds locally</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-013] [P] [SERVICES] [P1] Create <code>services/realtime/Dockerfile.egress</code> — arc-realtime-egress (LK Egress)</p><ul><li>Dependencies: TASK-001</li><li>Module: <code>services/realtime/Dockerfile.egress</code></li><li>Acceptance: <ul><li><code>FROM livekit/egress</code></li><li>OCI labels: <code>org.opencontainers.image.title</code>, <code>org.opencontainers.image.description</code>, <code>org.opencontainers.image.source</code></li><li>Arc service labels: <code>arc.service.name=arc-realtime-egress</code>, <code>arc.service.codename=scribe</code>, <code>arc.service.tech=livekit-egress</code>, <code>arc.service.role=realtime-egress</code></li><li>Non-root handling: same verify-and-document pattern as TASK-011</li><li>Dockerfile comment: <code># NOTE: livekit/egress bundles headless Chromium (~1GB). Track-based egress (no Chrome) is a future optimization (see plan.md TD-005).</code></li><li><code>docker build -f services/realtime/Dockerfile.egress services/realtime/</code> succeeds locally</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-014] [P] [SERVICES] [P1] Create <code>services/realtime/livekit.yaml</code>, <code>ingress.yaml</code>, <code>egress.yaml</code></p><ul><li>Dependencies: TASK-001</li><li>Module: <code>services/realtime/</code></li><li>Acceptance: <ul><li><code>livekit.yaml</code>: <ul><li><code>port: 7880</code>, <code>grpc_port: 7881</code></li><li><code>rtc.tcp_port: 7882</code>, <code>rtc.udp_port_range_start: 50100</code>, <code>rtc.udp_port_range_end: 50200</code></li><li><code>rtc.use_external_ip: false</code></li><li><code>rtc.node_ip</code> sourced from env (LiveKit supports <code>\${LIVEKIT_NODE_IP}</code> or compose env injection)</li><li><code>redis.address: arc-cache:6379</code></li><li><code>keys:</code> block with <code>devkey: devsecret</code></li><li>Comment: <code># API keys are static dev values. Production: replace with dynamic secrets from OpenBao.</code></li></ul></li><li><code>ingress.yaml</code>: <ul><li><code>api_url: ws://arc-realtime:7880</code></li><li><code>api_key: devkey</code>, <code>api_secret: devsecret</code></li><li>Health port: 7888 (either via config key or LK Ingress env <code>HEALTH_PORT=7888</code>)</li></ul></li><li><code>egress.yaml</code>: <ul><li><code>api_url: ws://arc-realtime:7880</code></li><li><code>api_key: devkey</code>, <code>api_secret: devsecret</code></li><li>S3/MinIO output config pointing to <code>http://arc-storage:9000</code>, bucket <code>recordings</code>, credentials <code>arc</code>/<code>arc-minio-dev</code>, <code>force_path_style: true</code></li><li>Comment: <code># &#39;recordings&#39; bucket must exist in arc-storage. Run: docker exec arc-storage mc mb /data/recordings</code></li></ul></li><li>All three files are valid YAML: <code>python3 -c &quot;import yaml; [yaml.safe_load(open(f)) for f in [&#39;services/realtime/livekit.yaml&#39;,&#39;services/realtime/ingress.yaml&#39;,&#39;services/realtime/egress.yaml&#39;]]&quot;</code> exits 0</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-015] [P] [SERVICES] [P1] Create <code>services/realtime/service.yaml</code></p><ul><li>Dependencies: TASK-001</li><li>Module: <code>services/realtime/service.yaml</code></li><li>Acceptance: <ul><li>Fields present: <code>name: arc-realtime</code>, <code>codename: daredevil</code>, <code>role: realtime</code>, <code>image: ghcr.io/arc-framework/arc-realtime:latest</code>, <code>tech: livekit</code>, <code>upstream: livekit/livekit-server</code></li><li><code>ports</code> list includes: 7880 (http, LiveKit API + WebRTC signalling), 7881 (grpc, gRPC API), 7882 (tcp, TURN), 50100-50200 (udp, WebRTC RTP media)</li><li><code>health.endpoint: http://localhost:7880</code></li><li><code>depends_on: [cache]</code></li><li><code>sidecars</code> list includes: <ul><li><code>{ name: arc-realtime-ingress, codename: sentry, port: 7888, description: &quot;RTMP ingest&quot; }</code></li><li><code>{ name: arc-realtime-egress, codename: scribe, port: 7889, description: &quot;Recording + export&quot; }</code></li></ul></li><li>Valid YAML: <code>python3 -c &quot;import yaml; yaml.safe_load(open(&#39;services/realtime/service.yaml&#39;))&quot;</code> exits 0</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-3-assembly" tabindex="-1">Phase 3: Assembly <a class="header-anchor" href="#phase-3-assembly" aria-label="Permalink to &quot;Phase 3: Assembly&quot;">​</a></h2><p>Both compose and .mk can be written in parallel (different files).</p><ul><li><p>[x] [TASK-021] [P] [SERVICES] [P1] Create <code>services/realtime/docker-compose.yml</code> — all 3 services</p><ul><li>Dependencies: TASK-011, TASK-012, TASK-013, TASK-014</li><li>Module: <code>services/realtime/docker-compose.yml</code></li><li>Acceptance: <ul><li><strong>arc-realtime</strong> service: <ul><li><code>image: ghcr.io/arc-framework/arc-realtime:latest</code>; <code>build: {context: services/realtime, dockerfile: Dockerfile}</code></li><li><code>command: --config /etc/livekit.yaml</code></li><li>Volume: <code>./services/realtime/livekit.yaml:/etc/livekit.yaml:ro</code></li><li><code>environment: LIVEKIT_NODE_IP: \${LIVEKIT_NODE_IP:-127.0.0.1}</code></li><li>Ports: <code>127.0.0.1:7880:7880</code>, <code>127.0.0.1:7881:7881</code>, <code>127.0.0.1:7882:7882</code>, <code>0.0.0.0:50100-50200:50100-50200/udp</code></li><li>Port comment: <code># UDP 0.0.0.0 — WebRTC RTP media requires host-reachable port range for NAT traversal</code></li><li><code>depends_on: {arc-cache: {condition: service_healthy}}</code></li><li>Healthcheck: <code>wget -qO- http://localhost:7880 || exit 1</code> (fallback: <code>curl -sf http://localhost:7880</code>); interval 5s, timeout 3s, retries 5, start_period 10s</li><li><code>restart: unless-stopped</code></li></ul></li><li><strong>arc-realtime-ingress</strong> service: <ul><li><code>image: ghcr.io/arc-framework/arc-realtime-ingress:latest</code>; dockerfile: <code>Dockerfile.ingress</code></li><li>Volume: <code>./services/realtime/ingress.yaml:/etc/ingress.yaml:ro</code></li><li>Ports: <code>127.0.0.1:7888:7888</code>, <code>127.0.0.1:1935:1935</code></li><li><code>depends_on: {arc-realtime: {condition: service_healthy}}</code></li><li>Healthcheck: <code>:7888</code>; interval 5s, timeout 3s, retries 5, start_period 10s</li></ul></li><li><strong>arc-realtime-egress</strong> service: <ul><li><code>image: ghcr.io/arc-framework/arc-realtime-egress:latest</code>; dockerfile: <code>Dockerfile.egress</code></li><li>Volume: <code>./services/realtime/egress.yaml:/etc/egress.yaml:ro</code></li><li>Ports: <code>127.0.0.1:7889:7889</code></li><li><code>depends_on: {arc-realtime: {condition: service_healthy}}</code></li><li>Healthcheck: <code>:7889</code>; interval 5s, timeout 3s, retries 5, start_period 15s</li></ul></li><li><code>networks: {arc_platform_net: {external: true}}</code> at file bottom</li><li><code>docker compose -f services/realtime/docker-compose.yml config</code> passes without errors</li></ul></li><li><strong>Deviations (documented):</strong><ul><li><code>depends_on: arc-cache</code> omitted — Docker Compose v2 cannot express <code>condition: service_healthy</code> across separate compose files. The <code>arc-cache</code> service lives in <code>services/cache/docker-compose.yml</code>. Cross-compose ordering is delegated to the <code>.mk</code> layer: <code>make realtime-up</code> must be called after <code>make cache-up</code> (enforced by <code>SERVICE_realtime_DEPENDS := cache</code> in registry.mk). Comment added to compose file documents this: <code># arc-cache (Redis) must be running for multi-node pub/sub.</code></li><li>Healthchecks use <code>nc -z localhost &lt;port&gt;</code> instead of <code>wget</code>/<code>curl</code> — LiveKit images are Alpine-based with busybox netcat but no wget/curl in PATH. <code>nc -z</code> is more reliable for TCP port-open checks.</li><li>Retries increased from 5 → 10 (LK Server), start_period from 10s/15s → 15s/20s — LiveKit Server and Egress (Chromium bundle ~1GB) have slow cold-start; higher values prevent false-unhealthy on first launch. Conservative values; can be tuned down once baseline startup time is measured.</li><li><code>NODE_IP</code> env var name used in compose (matching LiveKit docs); spec said <code>LIVEKIT_NODE_IP</code>. Both work — the compose file maps <code>NODE_IP: \${LIVEKIT_NODE_IP:-127.0.0.1}</code>, so the override env var is still <code>LIVEKIT_NODE_IP</code> as documented in <code>realtime-help</code>.</li><li><code>ws_url</code> used in ingress.yaml/egress.yaml instead of <code>api_url</code> — <code>ws_url</code> is the correct LiveKit SDK config key for the WebSocket connection URL. Spec used <code>api_url</code> which is not a valid LK field.</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-022] [P] [SERVICES] [P1] Create <code>services/realtime/realtime.mk</code></p><ul><li>Dependencies: TASK-021</li><li>Module: <code>services/realtime/realtime.mk</code></li><li>Acceptance: <ul><li>Image variables declared: <code>REALTIME_IMAGE</code>, <code>REALTIME_INGRESS_IMG</code>, <code>REALTIME_EGRESS_IMG</code></li><li><code>COMPOSE_REALTIME := docker compose -f services/realtime/docker-compose.yml</code></li><li><strong>Core targets</strong>: <code>realtime-help</code>, <code>realtime-up</code>, <code>realtime-down</code>, <code>realtime-health</code>, <code>realtime-logs</code>, <code>realtime-clean</code>, <code>realtime-nuke</code></li><li><strong>Build targets</strong>: <code>realtime-build</code> (Dockerfile), <code>realtime-build-fresh</code>, <code>realtime-ingress-build</code> (Dockerfile.ingress), <code>realtime-ingress-build-fresh</code>, <code>realtime-egress-build</code> (Dockerfile.egress), <code>realtime-egress-build-fresh</code></li><li><strong>Push/publish targets</strong>: <code>realtime-push</code>, <code>realtime-publish</code>, <code>realtime-tag</code>; <code>realtime-ingress-push</code>, <code>realtime-ingress-publish</code>; <code>realtime-egress-push</code>, <code>realtime-egress-publish</code></li><li><strong>Individual service targets</strong>: <code>realtime-ingress-up</code>, <code>realtime-ingress-down</code>, <code>realtime-ingress-health</code>, <code>realtime-ingress-logs</code>; <code>realtime-egress-up</code>, <code>realtime-egress-down</code>, <code>realtime-egress-health</code>, <code>realtime-egress-logs</code></li><li><code>realtime-up</code>: calls <code>docker network create arc_platform_net 2&gt;/dev/null || true</code> before compose up</li><li><code>realtime-health</code>: probes all three — <code>curl -sf http://localhost:7880</code>, <code>curl -sf http://localhost:7888</code>, <code>curl -sf http://localhost:7889</code>; exits 0 only if all pass</li><li><code>realtime-ingress-health</code>: probes <code>:7888</code>; <code>realtime-egress-health</code>: probes <code>:7889</code></li><li><code>realtime-help</code>: lists all targets; includes notes: &quot;UDP 50100-50200 must be open on host firewall for WebRTC&quot; and &quot;Set LIVEKIT_NODE_IP=&lt;machine-ip&gt; for non-local clients&quot;</li><li><code>realtime-clean</code> / <code>realtime-nuke</code>: confirm before destructive action; nuke warns &quot;active WebRTC rooms will be disconnected&quot;</li><li><code>make -n realtime-up</code> dry-run passes</li><li><code>make -n realtime-health</code> dry-run passes</li><li>All targets declare <code>.PHONY</code></li><li>All targets use <code>COLOR_INFO</code>, <code>COLOR_OK</code>, <code>COLOR_ERR</code> from root Makefile</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-4-wiring" tabindex="-1">Phase 4: Wiring <a class="header-anchor" href="#phase-4-wiring" aria-label="Permalink to &quot;Phase 4: Wiring&quot;">​</a></h2><ul><li>[x] [TASK-031] [SERVICES] [P1] Update root <code>Makefile</code>, <code>scripts/scripts.mk</code>, and <code>scripts/lib/check-dev-prereqs.sh</code><ul><li>Dependencies: TASK-022</li><li>Module: <code>Makefile</code>, <code>scripts/scripts.mk</code>, <code>scripts/lib/check-dev-prereqs.sh</code></li><li>Acceptance: <ul><li>Root <code>Makefile</code>: <code>include services/realtime/realtime.mk</code> added to Services section (after control.mk include)</li><li><code>scripts/scripts.mk</code> <code>publish-all</code> target: three new lines added:<div class="language-makefile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> realtime-build         realtime-publish         --no-print-directory</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> realtime-ingress-build realtime-ingress-publish --no-print-directory</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">$(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> realtime-egress-build  realtime-egress-publish  --no-print-directory</span></span></code></pre></div></li><li><code>scripts/lib/check-dev-prereqs.sh</code> <code>port_to_service()</code> function: add port mappings: <ul><li><code>7880</code> → <code>daredevil</code> (or equivalent realtime service label)</li><li><code>7881</code> → <code>daredevil-grpc</code></li><li><code>1935</code> → <code>sentry-rtmp</code></li></ul></li><li><code>make -n publish-all</code> dry-run includes realtime build/publish steps</li><li><code>make help</code> lists <code>realtime-help</code></li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-5-ci-cd-parallel" tabindex="-1">Phase 5: CI/CD (parallel) <a class="header-anchor" href="#phase-5-ci-cd-parallel" aria-label="Permalink to &quot;Phase 5: CI/CD (parallel)&quot;">​</a></h2><p>Both workflows are independent and can be implemented concurrently.</p><ul><li><p>[x] [TASK-041] [P] [CI] [P2] Create <code>.github/workflows/realtime-images.yml</code></p><ul><li>Dependencies: TASK-031</li><li>Module: <code>.github/workflows/realtime-images.yml</code></li><li>Acceptance: <ul><li>Mirrors <code>control-images.yml</code> / <code>data-images.yml</code> structure exactly</li><li><code>on.push.branches: [main]</code> + <code>on.push.paths: [&quot;services/realtime/**&quot;, &quot;.github/workflows/realtime-images.yml&quot;]</code></li><li><code>on.pull_request.paths</code>: same path</li><li><code>on.workflow_dispatch</code> with <code>mode</code> input (<code>ci</code> / <code>release</code>)</li><li><code>changes</code> job: <code>dorny/paths-filter@v3</code> with filter <code>realtime: services/realtime/**</code></li><li><code>build-realtime</code>, <code>build-realtime-ingress</code>, <code>build-realtime-egress</code> jobs: <ul><li>Parallel; each uses <code>_reusable-build.yml</code></li><li><code>platforms: linux/amd64</code> (amd64-only in CI — no QEMU for speed)</li><li><code>service-path: services/realtime</code>; <code>dockerfile: Dockerfile</code> / <code>Dockerfile.ingress</code> / <code>Dockerfile.egress</code></li><li><code>image-name: arc-realtime</code> / <code>arc-realtime-ingress</code> / <code>arc-realtime-egress</code></li></ul></li><li><code>security-*</code> jobs after each build; <code>block-on-failure: false</code> in CI</li><li>YAML parses: <code>python3 -c &quot;import yaml,sys; yaml.safe_load(open(&#39;.github/workflows/realtime-images.yml&#39;))&quot;</code> exits 0</li><li>Three images built: <code>arc-realtime</code>, <code>arc-realtime-ingress</code>, <code>arc-realtime-egress</code></li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-042] [P] [CI] [P2] Create <code>.github/workflows/realtime-release.yml</code></p><ul><li>Dependencies: TASK-031</li><li>Module: <code>.github/workflows/realtime-release.yml</code></li><li>Acceptance: <ul><li>Mirrors <code>control-release.yml</code> / <code>data-release.yml</code> structure exactly</li><li><code>on.push.tags: [&quot;realtime/v*&quot;]</code></li><li><code>prepare</code> job: derives <code>image-tag</code> (<code>realtime/v0.1.0</code> → <code>realtime-v0.1.0</code>), <code>version</code>, <code>prerelease</code> outputs</li><li><code>build-realtime</code>, <code>build-realtime-ingress</code>, <code>build-realtime-egress</code> jobs: parallel after <code>prepare</code><ul><li><code>platforms: linux/amd64,linux/arm64</code>; <code>push-image: true</code>; <code>latest-tag: true</code>; <code>image-tag: \${{ needs.prepare.outputs.image-tag }}</code></li></ul></li><li><code>security-*</code> jobs: <code>block-on-failure: true</code>; <code>create-issues: true</code> (CRITICAL CVEs block release)</li><li><code>release</code> job: image table listing <code>arc-realtime</code>, <code>arc-realtime-ingress</code>, <code>arc-realtime-egress</code> with GHCR links; creates GitHub release via <code>softprops/action-gh-release@v2</code></li><li>Release notes include: <code>make realtime-up</code> / <code>make realtime-health</code> quickstart; <code>LIVEKIT_NODE_IP</code> env doc</li><li>YAML parses without errors</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-6-integration" tabindex="-1">Phase 6: Integration <a class="header-anchor" href="#phase-6-integration" aria-label="Permalink to &quot;Phase 6: Integration&quot;">​</a></h2><ul><li>[x] [TASK-051] [SERVICES] [P1] End-to-end verification — realtime stack up + health <ul><li>Dependencies: TASK-041, TASK-042</li><li>Module: <code>services/realtime/</code></li><li>Pre-condition: <code>arc-cache</code> must be running (<code>make cache-up</code> first)</li><li>Acceptance: <ul><li><code>docker network create arc_platform_net 2&gt;/dev/null || true</code> runs without error</li><li><code>make realtime-up</code> exits 0</li><li><code>docker compose -f services/realtime/docker-compose.yml ps</code> shows all three containers in <code>healthy</code> state: <code>arc-realtime</code>, <code>arc-realtime-ingress</code>, <code>arc-realtime-egress</code></li><li><code>make realtime-health</code> exits 0 (all three probes pass)</li><li><code>curl -s http://localhost:7880</code> returns a LiveKit response (2xx or redirect)</li><li><code>curl -sf http://localhost:7888</code> returns HTTP 200 (Ingress controller alive)</li><li><code>curl -sf http://localhost:7889</code> returns HTTP 200 (Egress controller alive)</li><li>TCP ports 7880/7881/7882/7888/1935/7889 bind <code>127.0.0.1</code> — confirm with <code>docker compose -f services/realtime/docker-compose.yml ps</code></li><li>UDP 50100-50200 binds <code>0.0.0.0</code> — confirm and document exception is intentional</li><li>Config files mounted read-only: <code>docker inspect arc-realtime --format &#39;{{json .Mounts}}&#39;</code> shows <code>/etc/livekit.yaml</code> with <code>RW:false</code></li><li><code>make realtime-down</code> exits 0; no orphaned containers</li><li>Individual targets work: <code>make realtime-ingress-health</code> exits 0; <code>make realtime-egress-health</code> exits 0</li><li><code>make dev PROFILE=think</code> starts <code>realtime</code> along with other think-profile services</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="phase-7-polish" tabindex="-1">Phase 7: Polish <a class="header-anchor" href="#phase-7-polish" aria-label="Permalink to &quot;Phase 7: Polish&quot;">​</a></h2><ul><li><p>[x] [TASK-900] [P] [DOCS] [P1] Docs &amp; links update</p><ul><li>Dependencies: TASK-051</li><li>Module: <code>CLAUDE.md</code>, <code>.specify/config.yaml</code>, <code>services/profiles.yaml</code></li><li>Acceptance: <ul><li><code>CLAUDE.md</code> monorepo layout: <code>services/realtime/</code> entry added (Daredevil/Sentry/Scribe LiveKit)</li><li><code>CLAUDE.md</code> Service Codenames table: three new rows added: <ul><li>Daredevil | LiveKit Server (realtime)</li><li>Sentry | LiveKit Ingress (realtime-ingress)</li><li>Scribe | LiveKit Egress (realtime-egress)</li></ul></li><li><code>.specify/config.yaml</code> <code>services</code> list: <code>realtime</code> entry updated to <code>{ dir: &quot;realtime&quot;, codename: &quot;daredevil&quot;, tech: &quot;livekit&quot;, lang: &quot;config&quot; }</code>; confirm <code>realtime-ingress</code> (sentry) and <code>realtime-egress</code> (scribe) entries added if needed</li><li><code>services/profiles.yaml</code> <code>think</code> includes <code>realtime</code>; <code>reason</code> includes <code>realtime</code> (verify final state from TASK-001)</li><li>No broken internal references in modified files</li></ul></li><li>Status: [x]</li></ul></li><li><p>[x] [TASK-999] [REVIEW] [P1] Reviewer agent verification</p><ul><li>Dependencies: ALL</li><li>Module: all affected modules</li><li>Acceptance (reviewer runs all items without opening plan.md): <ul><li>All tasks TASK-001 through TASK-900 marked <code>[x]</code> complete</li><li><strong>Stack health</strong> (pre-condition: <code>make cache-up</code>): <ul><li><code>make realtime-up</code> exits 0</li><li><code>docker compose -f services/realtime/docker-compose.yml ps</code> shows all three containers <code>healthy</code></li><li><code>make realtime-health</code> exits 0</li><li><code>make realtime-down</code> exits 0; no orphaned containers</li></ul></li><li><strong>Individual service health</strong>: <ul><li><code>curl -s http://localhost:7880</code> → LiveKit response</li><li><code>curl -sf http://localhost:7888</code> → HTTP 200 (Ingress)</li><li><code>curl -sf http://localhost:7889</code> → HTTP 200 (Egress)</li></ul></li><li><strong>Port binding</strong>: <ul><li>TCP ports bind <code>127.0.0.1</code> only — verified via <code>docker compose ps</code></li><li>UDP 50100-50200 binds <code>0.0.0.0</code> — documented as intentional WebRTC exception</li></ul></li><li><strong>Config mounts</strong>: livekit.yaml, ingress.yaml, egress.yaml all mounted read-only</li><li><strong>API key consistency</strong>: <code>devkey</code>/<code>devsecret</code> identical across all three config files</li><li><strong>Dockerfiles</strong>: <ul><li>All three have OCI (<code>org.opencontainers.*</code>) + <code>arc.service.*</code> labels including <code>arc.service.codename</code></li><li>Non-root status verified per image; root deviation documented if required</li><li>Egress Dockerfile has note about Chromium bundle</li></ul></li><li><strong>service.yaml</strong>: contains role, codename, image, ports, health, depends_on, sidecars</li><li><strong>realtime.mk</strong>: <ul><li><code>make -n realtime-up</code> dry-run passes</li><li><code>make -n realtime-health</code> dry-run passes</li><li><code>make realtime-help</code> includes <code>LIVEKIT_NODE_IP</code> and UDP firewall notes</li></ul></li><li><strong>Makefile</strong>: <code>include services/realtime/realtime.mk</code> present</li><li><strong>scripts/scripts.mk</strong>: <code>publish-all</code> includes all three realtime build/publish steps</li><li><strong>check-dev-prereqs.sh</strong>: ports 7880, 7881, 1935 added</li><li><strong>profiles.yaml</strong>: <code>think</code> and <code>reason</code> both include <code>realtime</code>; <code>ultra-instinct</code> unchanged (<code>&#39;*&#39;</code>)</li><li><strong>CI</strong>: <ul><li><code>realtime-images.yml</code> path filter <code>services/realtime/**</code>; 3 image builds; amd64 only</li><li><code>realtime-release.yml</code> tag format <code>realtime/v*</code>; platforms <code>linux/amd64,linux/arm64</code></li></ul></li><li><strong>Docs</strong>: CLAUDE.md codenames table has Daredevil/Sentry/Scribe; layout has <code>services/realtime/</code></li><li><strong>Constitution compliance verified</strong>: <ul><li>II PASS: <code>make realtime-up</code> boots all three; joined to <code>think</code> (minimal profile)</li><li>III PASS: self-contained in <code>services/realtime/</code>; own service.yaml + compose + .mk</li><li>IV PASS: config-only upstream images, no custom Python/Go code</li><li>V PASS: same Dockerfile/compose/healthcheck/CI structure as 003/005/006</li><li>VII PASS: HTTP health endpoints :7880/:7888/:7889 with Docker healthchecks</li><li>VIII PASS†: TCP 127.0.0.1; UDP 0.0.0.0 exception documented; no secrets in git</li><li>XI PASS: depends_on ordering (cache → realtime → ingress/egress); start_periods set</li></ul></li><li>No TODO/FIXME in any file without a corresponding plan.md TD-* entry</li></ul></li><li>Status: [x]</li></ul></li></ul><hr><h2 id="progress-summary" tabindex="-1">Progress Summary <a class="header-anchor" href="#progress-summary" aria-label="Permalink to &quot;Progress Summary&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Phase</th><th>Total</th><th>Done</th><th>Parallel</th></tr></thead><tbody><tr><td>Setup</td><td>1</td><td>1</td><td>0</td></tr><tr><td>Core Files</td><td>5</td><td>5</td><td>5</td></tr><tr><td>Assembly</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Wiring</td><td>1</td><td>1</td><td>0</td></tr><tr><td>CI/CD</td><td>2</td><td>2</td><td>2</td></tr><tr><td>Integration</td><td>1</td><td>1</td><td>0</td></tr><tr><td>Polish</td><td>2</td><td>2</td><td>0</td></tr><tr><td><strong>Total</strong></td><td><strong>14</strong></td><td><strong>14</strong></td><td><strong>9</strong></td></tr></tbody></table>`,29))])}const T=s(p,[["render",u]]);export{b as __pageData,T as default};
