import{_ as d,C as p,o as t,c as h,an as c,b as n,w as a,a as s,E as l,ao as r,j as o}from"./chunks/framework.CTqRDTHW.js";const b=JSON.parse('{"title":"Implementation Plan: Messaging & Cache Services Setup","description":"","frontmatter":{},"headers":[],"relativePath":"003-messaging-setup/plan.md","filePath":"003-messaging-setup/plan.md","lastUpdated":1772310733000}'),k={name:"003-messaging-setup/plan.md"};function g(m,e,u,E,f,y){const i=p("Mermaid");return t(),h("div",null,[e[4]||(e[4]=c('<h1 id="implementation-plan-messaging-cache-services-setup" tabindex="-1">Implementation Plan: Messaging &amp; Cache Services Setup <a class="header-anchor" href="#implementation-plan-messaging-cache-services-setup" aria-label="Permalink to &quot;Implementation Plan: Messaging &amp; Cache Services Setup&quot;">​</a></h1><blockquote><p><strong>Spec</strong>: 003-messaging-setup <strong>Date</strong>: 2026-02-23</p></blockquote><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>Add three infrastructure services — NATS (Flash), Pulsar (Strange), Redis (Sonic) — each following the exact same structural pattern as the OTEL stack: thin version-pinned Dockerfile, <code>service.yaml</code>, <code>docker-compose.yml</code>, dedicated <code>.mk</code> include, and CI/release workflows. Network topology is simplified to two networks: <code>arc_platform_net</code> (shared, external) and <code>arc_otel_net</code> (internal to otel storage). The otel collector gains a Prometheus receiver and joins <code>arc_platform_net</code> so it can scrape NATS and Pulsar metrics. Profiles are updated so the <code>think</code> profile bootstraps messaging alongside cortex.</p><h2 id="target-modules" tabindex="-1">Target Modules <a class="header-anchor" href="#target-modules" aria-label="Permalink to &quot;Target Modules&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Module</th><th>Language</th><th>Changes</th></tr></thead><tbody><tr><td><code>services/messaging/</code></td><td>Config/Dockerfile</td><td>New — NATS (Flash)</td></tr><tr><td><code>services/streaming/</code></td><td>Config/Dockerfile</td><td>New — Pulsar (Strange)</td></tr><tr><td><code>services/cache/</code></td><td>Config/Dockerfile</td><td>New — Redis (Sonic)</td></tr><tr><td><code>services/otel/telemetry/</code></td><td>YAML</td><td>Update collector config — add prometheus receiver + arc_platform_net</td></tr><tr><td><code>services/otel/docker-compose.yml</code></td><td>YAML</td><td>Add arc_platform_net to collector service</td></tr><tr><td><code>services/profiles.yaml</code></td><td>YAML</td><td>Add flash, strange, sonic to <code>think</code> profile</td></tr><tr><td><code>.github/workflows/</code></td><td>YAML</td><td>New — messaging-images.yml + messaging-release.yml</td></tr><tr><td><code>Makefile</code></td><td>Make</td><td>Include flash.mk, strange.mk, sonic.mk</td></tr></tbody></table><h2 id="technical-context" tabindex="-1">Technical Context <a class="header-anchor" href="#technical-context" aria-label="Permalink to &quot;Technical Context&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Aspect</th><th>Value</th></tr></thead><tbody><tr><td>Language</td><td>Config-only (YAML, Dockerfile) — no application code</td></tr><tr><td>Base Images</td><td><code>nats:alpine</code>, <code>apachepulsar/pulsar:latest</code>, <code>redis:alpine</code> — floating tags, consistent with platform-spike</td></tr><tr><td>Testing</td><td><code>docker compose ps</code>, <code>curl</code>, <code>redis-cli ping</code>, <code>nats stream ls</code></td></tr><tr><td>OTEL Collector</td><td><code>signoz/signoz-otel-collector:v0.142.0</code> — add <code>prometheus</code> receiver</td></tr><tr><td>Network</td><td><code>arc_platform_net</code> (external bridge) + <code>arc_otel_net</code> (internal)</td></tr><tr><td>Volumes</td><td>Named Docker volumes: <code>arc-messaging-jetstream</code>, <code>arc-streaming-data</code>, <code>arc-cache-data</code></td></tr><tr><td>CI Pattern</td><td>Mirror <code>cortex-images.yml</code> — amd64-only CI, dorny/paths-filter per service</td></tr></tbody></table><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h2><h3 id="network-topology" tabindex="-1">Network topology <a class="header-anchor" href="#network-topology" aria-label="Permalink to &quot;Network topology&quot;">​</a></h3>',10)),(t(),n(r,null,{default:a(()=>[l(i,{id:"mermaid-201",class:"mermaid",graph:"graph%20TB%0A%20%20%20%20subgraph%20Host%0A%20%20%20%20%20%20%20%20subgraph%20arc_platform_net%20%5Barc_platform_net%20%E2%80%94%20external%20bridge%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20flash%5B%22arc-messaging%5Cnnats%3A2.10-alpine%5Cn4222%20%E2%80%A2%208222%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20strange%5B%22arc-streaming%5Cnpulsar%3A3.3.0%5Cn6650%20%E2%80%A2%208082%E2%86%928080%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20sonic%5B%22arc-cache%5Cnredis%3A7.4-alpine%5Cn6379%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20collector%5B%22arc-friday-collector%5Cnsignoz%20otel%20v0.142%5Cn4317%20%E2%80%A2%204318%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20cortex%5B%22arc-cortex%5Cn%3A8081%22%5D%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20%20%20%20%20subgraph%20arc_otel_net%20%5Barc_otel_net%20%E2%80%94%20internal%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20zk%5B%22arc-friday-zookeeper%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20ch%5B%22arc-friday-clickhouse%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20friday%5B%22arc-friday%20%2F%20SigNoz%5Cn%3A3301%22%5D%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20collector%20--%20%22prometheus%20scrape%5Cnarc-messaging%3A8222%2Fmetrics%22%20--%3E%20flash%0A%20%20%20%20collector%20--%20%22prometheus%20scrape%5Cnarc-streaming%3A8080%2Fmetrics%22%20--%3E%20strange%0A%20%20%20%20collector%20--%20%22OTLP%20export%5Cnclickhousetraces%2Fmetrics%2Flogs%22%20--%3E%20ch%0A%20%20%20%20cortex%20--%20%22nats%3A%2F%2F4222%22%20--%3E%20flash%0A%20%20%20%20cortex%20--%20%22pulsar%3A%2F%2F6650%22%20--%3E%20strange%0A%20%20%20%20cortex%20--%20%22redis%3A%2F%2F6379%22%20--%3E%20sonic%0A"})]),fallback:a(()=>[...e[0]||(e[0]=[s(" Loading... ",-1)])]),_:1})),e[5]||(e[5]=o("h3",{id:"collector-config-delta",tabindex:"-1"},[s("Collector config delta "),o("a",{class:"header-anchor",href:"#collector-config-delta","aria-label":'Permalink to "Collector config delta"'},"​")],-1)),(t(),n(r,null,{default:a(()=>[l(i,{id:"mermaid-205",class:"mermaid",graph:"flowchart%20LR%0A%20%20%20%20subgraph%20Before%0A%20%20%20%20%20%20%20%20B_otlp%5Botlp%20receiver%5D%20--%3E%20B_batch%5Bbatch%5D%20--%3E%20B_exp%5Bclickhouse%20exporters%5D%0A%20%20%20%20end%0A%20%20%20%20subgraph%20After%0A%20%20%20%20%20%20%20%20A_otlp%5Botlp%20receiver%5D%20--%3E%20A_batch%5Bbatch%5D%20--%3E%20A_exp%5Bclickhouse%20exporters%5D%0A%20%20%20%20%20%20%20%20A_prom%5Bprometheus%20receiver%5Cnarc-messaging%3A8222%5Cnarc-streaming%3A8080%5D%20--%3E%20A_batch%0A%20%20%20%20end%0A"})]),fallback:a(()=>[...e[1]||(e[1]=[s(" Loading... ",-1)])]),_:1})),e[6]||(e[6]=o("h3",{id:"service-file-pattern-same-for-all-three",tabindex:"-1"},[s("Service file pattern (same for all three) "),o("a",{class:"header-anchor",href:"#service-file-pattern-same-for-all-three","aria-label":'Permalink to "Service file pattern (same for all three)"'},"​")],-1)),(t(),n(r,null,{default:a(()=>[l(i,{id:"mermaid-209",class:"mermaid",graph:"graph%20LR%0A%20%20%20%20A%5BDockerfile%5Cnpins%20upstream%20image%5Cnadds%20OCI%20%2B%20arc%20labels%5D%20--%3E%20B%5Bdocker-compose.yml%5Cnports%2C%20volumes%2C%20healthcheck%5Cnexternal%20arc_platform_net%5D%0A%20%20%20%20B%20--%3E%20C%5Bservice.yaml%5Cnname%2C%20codename%2C%20port%2C%20health%5D%0A%20%20%20%20C%20--%3E%20D%5Bflash.mk%20%2F%20strange.mk%20%2F%20sonic.mk%5Cnmake%20targets%3A%20up%2C%20down%2C%20health%2C%20logs%2C%20build%2C%20clean%2C%20nuke%5D%0A"})]),fallback:a(()=>[...e[2]||(e[2]=[s(" Loading... ",-1)])]),_:1})),e[7]||(e[7]=c(`<h2 id="constitution-check" tabindex="-1">Constitution Check <a class="header-anchor" href="#constitution-check" aria-label="Permalink to &quot;Constitution Check&quot;">​</a></h2><table tabindex="0"><thead><tr><th>#</th><th>Principle</th><th>Status</th><th>Evidence</th></tr></thead><tbody><tr><td>I</td><td>Zero-Dep CLI</td><td>N/A</td><td>No CLI changes</td></tr><tr><td>II</td><td>Platform-in-a-Box</td><td>PASS</td><td><code>make messaging-up</code> starts all three; <code>think</code> profile includes them</td></tr><tr><td>III</td><td>Modular Services</td><td>PASS</td><td>Each in own dir under <code>services/</code>; self-contained; added to profile</td></tr><tr><td>IV</td><td>Two-Brain</td><td>PASS</td><td>Config-only — no language concern</td></tr><tr><td>V</td><td>Polyglot Standards</td><td>PASS</td><td>Same Dockerfile/compose/healthcheck structure as otel</td></tr><tr><td>VI</td><td>Local-First</td><td>N/A</td><td>CLI only</td></tr><tr><td>VII</td><td>Observability</td><td>PASS</td><td>NATS + Pulsar scraped by collector → SigNoz; Redis deferred (TD-001)</td></tr><tr><td>VIII</td><td>Security</td><td>PASS</td><td>NATS+Redis run non-root; ports bind <code>127.0.0.1</code>; no secrets in compose</td></tr><tr><td>IX</td><td>Declarative</td><td>N/A</td><td>CLI only</td></tr><tr><td>X</td><td>Stateful Ops</td><td>N/A</td><td>CLI only</td></tr><tr><td>XI</td><td>Resilience</td><td>PASS</td><td>Health checks with correct start_periods; named volumes survive restarts</td></tr><tr><td>XII</td><td>Interactive</td><td>N/A</td><td>CLI only</td></tr></tbody></table><blockquote><p><strong>Known deviation — Pulsar non-root (NFR-1)</strong>: The <code>apachepulsar/pulsar:3.3.0</code> image requires root for <code>/pulsar</code> directory initialization. Documented in service.yaml and docker-compose.yml comments. No upstream non-root alternative available.</p></blockquote><h2 id="project-structure" tabindex="-1">Project Structure <a class="header-anchor" href="#project-structure" aria-label="Permalink to &quot;Project Structure&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>arc-platform/</span></span>
<span class="line"><span>├── services/</span></span>
<span class="line"><span>│   ├── messaging/                        ← NEW (Flash / NATS)</span></span>
<span class="line"><span>│   │   ├── Dockerfile                    # FROM nats:2.10-alpine; adds labels; non-root (nats uid 1000)</span></span>
<span class="line"><span>│   │   ├── service.yaml                  # name, codename, port, health</span></span>
<span class="line"><span>│   │   ├── docker-compose.yml            # arc-messaging container; arc_platform_net external</span></span>
<span class="line"><span>│   │   └── flash.mk                      # flash-up/down/health/logs/build/clean/nuke</span></span>
<span class="line"><span>│   ├── streaming/                        ← NEW (Strange / Pulsar)</span></span>
<span class="line"><span>│   │   ├── Dockerfile                    # FROM apachepulsar/pulsar:3.3.0; adds labels</span></span>
<span class="line"><span>│   │   ├── service.yaml</span></span>
<span class="line"><span>│   │   ├── docker-compose.yml            # arc-streaming; PULSAR_MEM; arc_platform_net external</span></span>
<span class="line"><span>│   │   └── strange.mk</span></span>
<span class="line"><span>│   ├── cache/                            ← NEW (Sonic / Redis)</span></span>
<span class="line"><span>│   │   ├── Dockerfile                    # FROM redis:7.4-alpine; adds labels; non-root</span></span>
<span class="line"><span>│   │   ├── service.yaml</span></span>
<span class="line"><span>│   │   ├── docker-compose.yml            # arc-cache; AOF; arc_platform_net external</span></span>
<span class="line"><span>│   │   └── sonic.mk</span></span>
<span class="line"><span>│   ├── otel/</span></span>
<span class="line"><span>│   │   ├── docker-compose.yml            # MODIFY — collector gains arc_platform_net</span></span>
<span class="line"><span>│   │   └── telemetry/</span></span>
<span class="line"><span>│   │       └── config/</span></span>
<span class="line"><span>│   │           └── otel-collector-config.yaml  # MODIFY — add prometheus receiver</span></span>
<span class="line"><span>│   └── profiles.yaml                     # MODIFY — think profile += flash, strange, sonic</span></span>
<span class="line"><span>├── .github/workflows/</span></span>
<span class="line"><span>│   ├── messaging-images.yml              ← NEW</span></span>
<span class="line"><span>│   └── messaging-release.yml            ← NEW</span></span>
<span class="line"><span>└── Makefile                              # MODIFY — include 3 new .mk files + messaging-* aggregates</span></span></code></pre></div><h2 id="key-implementation-decisions" tabindex="-1">Key Implementation Decisions <a class="header-anchor" href="#key-implementation-decisions" aria-label="Permalink to &quot;Key Implementation Decisions&quot;">​</a></h2><h3 id="_1-dockerfiles-are-thin-label-wrappers" tabindex="-1">1. Dockerfiles are thin label wrappers <a class="header-anchor" href="#_1-dockerfiles-are-thin-label-wrappers" aria-label="Permalink to &quot;1. Dockerfiles are thin label wrappers&quot;">​</a></h3><p>No config baked in — NATS/Redis/Pulsar are configured entirely via command-line flags in <code>docker-compose.yml</code>. The Dockerfile exists only to:</p><ul><li>Pin the upstream version (single source of truth for the image tag)</li><li>Add OCI labels (<code>org.opencontainers.image.*</code>) and <code>arc.service.*</code> labels</li><li>Set non-root user for NATS and Redis</li></ul><div class="language-dockerfile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">dockerfile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># flash/Dockerfile example</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">FROM</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> nats:2.10-alpine</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> org.opencontainers.image.title=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;ARC Flash — Messaging&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arc.service.codename=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;flash&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">LABEL</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> arc.service.tech=</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&quot;nats&quot;</span></span>
<span class="line"><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">USER</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> 1000  # nats user already exists in upstream image</span></span></code></pre></div><h3 id="_2-arc-platform-net-as-external-network" tabindex="-1">2. arc_platform_net as external network <a class="header-anchor" href="#_2-arc-platform-net-as-external-network" aria-label="Permalink to &quot;2. arc_platform_net as external network&quot;">​</a></h3><p>Each <code>docker-compose.yml</code> declares the network as external so services from different compose files can resolve each other by hostname:</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">networks</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  arc_platform_net</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    external</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">true</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arc_platform_net</span></span></code></pre></div><p>The network is created once: <code>docker network create arc_platform_net</code>. Makefile aggregate <code>messaging-up</code> ensures the network exists before starting containers.</p><h3 id="_3-collector-prometheus-receiver-—-scrape-over-arc-platform-net" tabindex="-1">3. Collector prometheus receiver — scrape over arc_platform_net <a class="header-anchor" href="#_3-collector-prometheus-receiver-—-scrape-over-arc-platform-net" aria-label="Permalink to &quot;3. Collector prometheus receiver — scrape over arc_platform_net&quot;">​</a></h3><p>The collector&#39;s <code>otel-collector-config.yaml</code> gains a <code>prometheus</code> receiver. The collector&#39;s <code>docker-compose.yml</code> entry gains <code>arc_platform_net</code> as a second network (it already has <code>arc_otel_net</code>).</p><div class="language-yaml vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">yaml</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># otel-collector-config.yaml additions</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">receivers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  prometheus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    config</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      scrape_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arc-messaging</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">15s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;arc-messaging:8222&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">        - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">job_name</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">arc-streaming</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          scrape_interval</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">30s</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">          static_configs</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">            - </span><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">targets</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">&#39;arc-streaming:8080&#39;</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">service</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">  pipelines</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">    metrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      receivers</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">otlp</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">, </span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">prometheus</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]   </span><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># was: [otlp]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      processors</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">batch</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span>
<span class="line"><span style="--shiki-light:#22863A;--shiki-dark:#85E89D;">      exporters</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">: [</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">signozclickhousemetrics</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">]</span></span></code></pre></div><h3 id="_4-makefile-aggregate-targets" tabindex="-1">4. Makefile aggregate targets <a class="header-anchor" href="#_4-makefile-aggregate-targets" aria-label="Permalink to &quot;4. Makefile aggregate targets&quot;">​</a></h3><p>A top-level <code>messaging.mk</code> (included in <code>Makefile</code>) provides the three-service orchestration. The per-service <code>.mk</code> files stay in their own directories.</p><div class="language-makefile vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">makefile</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;"># messaging.mk — aggregate: start all three</span></span>
<span class="line"><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">messaging-up</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">:</span></span>
<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">    @docker network create arc_platform_net 2&gt;/dev/null || true</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    $(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> flash-up --no-print-directory</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    $(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> strange-up --no-print-directory</span></span>
<span class="line"><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">    $(</span><span style="--shiki-light:#005CC5;--shiki-dark:#79B8FF;">MAKE</span><span style="--shiki-light:#032F62;--shiki-dark:#9ECBFF;">)</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> sonic-up --no-print-directory</span></span></code></pre></div><h3 id="_5-ci-workflow-pattern-mirrors-cortex-images-yml" tabindex="-1">5. CI workflow pattern (mirrors cortex-images.yml) <a class="header-anchor" href="#_5-ci-workflow-pattern-mirrors-cortex-images-yml" aria-label="Permalink to &quot;5. CI workflow pattern (mirrors cortex-images.yml)&quot;">​</a></h3><p>Single <code>messaging-images.yml</code> with per-service path filters and parallel build jobs — amd64 only:</p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>changes ──┬──&gt; test-flash (if flash changed)   ──&gt; build-flash</span></span>
<span class="line"><span>          ├──&gt; test-strange (if strange changed) ──&gt; build-strange  ──&gt; security</span></span>
<span class="line"><span>          └──&gt; test-sonic (if sonic changed)    ──&gt; build-sonic</span></span></code></pre></div><p>No Go/Python code → no test/lint jobs. Build jobs fire on Dockerfile or compose changes only.</p><h2 id="parallel-execution-strategy" tabindex="-1">Parallel Execution Strategy <a class="header-anchor" href="#parallel-execution-strategy" aria-label="Permalink to &quot;Parallel Execution Strategy&quot;">​</a></h2>`,25)),(t(),n(r,null,{default:a(()=>[l(i,{id:"mermaid-474",class:"mermaid",graph:"gantt%0A%20%20%20%20title%20Implementation%20Phases%0A%20%20%20%20dateFormat%20X%0A%20%20%20%20axisFormat%20%25s%0A%0A%20%20%20%20section%20Phase%201%20%E2%80%94%20Foundation%20(sequential)%0A%20%20%20%20Create%20arc_platform_net%20network%20infra%20%20%20%20%20%20%20%20%20%20%3Ap1a%2C%200%2C%201%0A%20%20%20%20Update%20profiles.yaml%20think%20profile%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap1b%2C%20after%20p1a%2C%201%0A%0A%20%20%20%20section%20Phase%202%20%E2%80%94%20Services%20(fully%20parallel)%0A%20%20%20%20Flash%3A%20Dockerfile%20%2B%20service.yaml%20%2B%20compose%20%20%20%20%20%3Ap2a%2C%20after%20p1b%2C%202%0A%20%20%20%20Strange%3A%20Dockerfile%20%2B%20service.yaml%20%2B%20compose%20%20%20%3Ap2b%2C%20after%20p1b%2C%202%0A%20%20%20%20Sonic%3A%20Dockerfile%20%2B%20service.yaml%20%2B%20compose%20%20%20%20%20%3Ap2c%2C%20after%20p1b%2C%202%0A%0A%20%20%20%20section%20Phase%203%20%E2%80%94%20Make%20targets%20(parallel%20per%20service)%0A%20%20%20%20flash.mk%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap3a%2C%20after%20p2a%2C%201%0A%20%20%20%20strange.mk%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap3b%2C%20after%20p2b%2C%201%0A%20%20%20%20sonic.mk%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap3c%2C%20after%20p2c%2C%201%0A%20%20%20%20messaging.mk%20aggregates%20%2B%20Makefile%20includes%20%20%20%20%3Ap3d%2C%20after%20p2c%2C%201%0A%0A%20%20%20%20section%20Phase%204%20%E2%80%94%20OTEL%20integration%20(sequential%2C%20needs%20Phase%202)%0A%20%20%20%20otel-collector-config.yaml%20%E2%80%94%20prometheus%20recv%20%20%20%3Ap4a%2C%20after%20p2a%2C%201%0A%20%20%20%20otel%20docker-compose.yml%20%E2%80%94%20add%20arc_platform_net%20%3Ap4b%2C%20after%20p4a%2C%201%0A%20%20%20%20Rebuild%20%2B%20test%20collector%20image%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap4c%2C%20after%20p4b%2C%201%0A%0A%20%20%20%20section%20Phase%205%20%E2%80%94%20CI%2FCD%20(parallel)%0A%20%20%20%20messaging-images.yml%20workflow%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap5a%2C%20after%20p3d%2C%202%0A%20%20%20%20messaging-release.yml%20workflow%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap5b%2C%20after%20p3d%2C%202%0A%0A%20%20%20%20section%20Phase%206%20%E2%80%94%20Integration%20test%0A%20%20%20%20make%20messaging-up%20%2B%20health%20checks%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap6%2C%20after%20p5b%2C%201%0A"})]),fallback:a(()=>[...e[3]||(e[3]=[s(" Loading... ",-1)])]),_:1})),e[8]||(e[8]=c('<p><strong>Parallelizable task groups:</strong></p><ul><li>Phase 2: Flash + Strange + Sonic service directories — fully independent</li><li>Phase 3: flash.mk + strange.mk + sonic.mk — independent after their Phase 2 deps</li><li>Phase 5: messaging-images.yml + messaging-release.yml — independent of each other</li></ul><h2 id="reviewer-checklist" tabindex="-1">Reviewer Checklist <a class="header-anchor" href="#reviewer-checklist" aria-label="Permalink to &quot;Reviewer Checklist&quot;">​</a></h2><ul><li>[ ] <code>make messaging-up</code> exits 0; all three containers in <code>healthy</code> state</li><li>[ ] <code>make messaging-health</code> exits 0</li><li>[ ] <code>make messaging-down</code> stops all three; no orphaned containers</li><li>[ ] <code>make flash-up &amp;&amp; make flash-health</code> works independently</li><li>[ ] <code>make strange-up &amp;&amp; make strange-health</code> works independently</li><li>[ ] <code>make sonic-up &amp;&amp; make sonic-health</code> works independently</li><li>[ ] <code>docker network inspect arc_platform_net</code> shows arc-messaging, arc-streaming, arc-cache, arc-friday-collector connected</li><li>[ ] <code>docker inspect arc-messaging | jq &#39;.[0].Config.User&#39;</code> returns non-root</li><li>[ ] <code>docker inspect arc-cache | jq &#39;.[0].Config.User&#39;</code> returns non-root</li><li>[ ] Pulsar non-root deviation is documented in <code>services/streaming/docker-compose.yml</code></li><li>[ ] All ports bind <code>127.0.0.1</code> — verify with <code>docker compose ps</code></li><li>[ ] All volumes are named (not bind mounts) — verify with <code>docker volume ls | grep arc</code></li><li>[ ] <code>otel-collector-config.yaml</code> has <code>prometheus</code> receiver; metrics pipeline includes it</li><li>[ ] <code>services/otel/docker-compose.yml</code> collector service has <code>arc_platform_net</code> network</li><li>[ ] <code>services/profiles.yaml</code> <code>think</code> profile includes flash, strange, sonic</li><li>[ ] <code>Makefile</code> includes flash.mk, strange.mk, sonic.mk, messaging.mk</li><li>[ ] <code>messaging-images.yml</code> runs only on relevant path changes; completes under 3 min</li><li>[ ] <code>messaging-release.yml</code> tag format <code>messaging/v*</code> builds multi-platform images</li><li>[ ] All Dockerfiles have OCI + <code>arc.service.*</code> labels</li><li>[ ] No secrets or credentials in any compose file</li></ul><h2 id="risks-mitigations" tabindex="-1">Risks &amp; Mitigations <a class="header-anchor" href="#risks-mitigations" aria-label="Permalink to &quot;Risks &amp; Mitigations&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Risk</th><th>Impact</th><th>Mitigation</th></tr></thead><tbody><tr><td>Pulsar standalone cold start &gt; 60s on slow machines</td><td>M</td><td><code>start_period: 90s</code> with 15 retries; <code>strange-health</code> probes with explicit timeout message</td></tr><tr><td><code>arc_platform_net</code> not created before compose up</td><td>H</td><td><code>messaging-up</code> calls <code>docker network create arc_platform_net 2&gt;/dev/null || true</code> first</td></tr><tr><td>Collector prometheus receiver syntax differs between SigNoz collector versions</td><td>M</td><td>Test with <code>docker compose config</code> after edit; collector version is pinned at v0.142.0</td></tr><tr><td>Port 8082 (Pulsar admin) conflict with other local services</td><td>L</td><td>Document in service.yaml; <code>strange-health</code> gives a clear error if bind fails</td></tr><tr><td>NATS JetStream stream auto-creation</td><td>L</td><td>NATS JetStream does not auto-create named streams — a post-start <code>nats stream add</code> step is needed if FR-4 is in scope; otherwise defer US-9 to a future task</td></tr></tbody></table>',6))])}const C=d(k,[["render",g]]);export{b as __pageData,C as default};
