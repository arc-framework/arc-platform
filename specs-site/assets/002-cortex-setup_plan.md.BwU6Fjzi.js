import{_ as c,C as p,o as s,c as h,an as l,b as o,w as t,a,E as n,ao as d,j as r}from"./chunks/framework.CTqRDTHW.js";const y=JSON.parse('{"title":"Implementation Plan: Cortex Bootstrap Service","description":"","frontmatter":{},"headers":[],"relativePath":"002-cortex-setup/plan.md","filePath":"002-cortex-setup/plan.md","lastUpdated":1772310733000}'),g={name:"002-cortex-setup/plan.md"};function u(A,e,k,m,E,b){const i=p("Mermaid");return s(),h("div",null,[e[5]||(e[5]=l('<h1 id="implementation-plan-cortex-bootstrap-service" tabindex="-1">Implementation Plan: Cortex Bootstrap Service <a class="header-anchor" href="#implementation-plan-cortex-bootstrap-service" aria-label="Permalink to &quot;Implementation Plan: Cortex Bootstrap Service&quot;">​</a></h1><blockquote><p><strong>Spec</strong>: 002-cortex-setup <strong>Date</strong>: 2026-02-22</p></blockquote><h2 id="summary" tabindex="-1">Summary <a class="header-anchor" href="#summary" aria-label="Permalink to &quot;Summary&quot;">​</a></h2><p>Cortex is a new Go service (<code>services/cortex/</code>) that provisions all A.R.C. platform infrastructure at startup. It exposes a Gin HTTP API (<code>POST /api/v1/bootstrap</code>, <code>/health</code>, <code>/health/deep</code>, <code>/ready</code>) and a Cobra CLI (<code>cortex server</code> / <code>cortex bootstrap</code>). All four bootstrap phases (Postgres schema validation, NATS JetStream stream creation, Pulsar tenant/topic provisioning, Redis ping) run in parallel via <code>errgroup</code>, each wrapped with a circuit breaker and exponential-backoff retry. OTEL traces and metrics are exported to <code>arc-friday-collector</code> at <code>arc-widow:4317</code>.</p><hr><h2 id="target-modules" tabindex="-1">Target Modules <a class="header-anchor" href="#target-modules" aria-label="Permalink to &quot;Target Modules&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Module</th><th>Language</th><th>Changes</th></tr></thead><tbody><tr><td><code>services/cortex/</code></td><td>Go</td><td>New service — full implementation</td></tr><tr><td><code>services/profiles.yaml</code></td><td>YAML</td><td>Add <code>cortex</code> to <code>think</code> and <code>reason</code> profiles</td></tr><tr><td><code>.specify/config.yaml</code></td><td>YAML</td><td>Update bootstrap entry: <code>dir: cortex</code>, <code>codename: cortex</code></td></tr><tr><td><code>.specify/meta/service-codename-map.md</code></td><td>Markdown</td><td>Add Cortex row</td></tr><tr><td><code>.specify/docs/architecture/cortex.md</code></td><td>Markdown</td><td>Architecture doc linked to implementation</td></tr></tbody></table><hr><h2 id="technical-context" tabindex="-1">Technical Context <a class="header-anchor" href="#technical-context" aria-label="Permalink to &quot;Technical Context&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Aspect</th><th>Value</th></tr></thead><tbody><tr><td>Language</td><td>Go</td></tr><tr><td>HTTP framework</td><td>Gin (<code>github.com/gin-gonic/gin</code>)</td></tr><tr><td>CLI framework</td><td>Cobra (<code>github.com/spf13/cobra</code>)</td></tr><tr><td>Config</td><td>Viper (<code>github.com/spf13/viper</code>) — precedence: flags → env → YAML → defaults</td></tr><tr><td>NATS client</td><td><code>github.com/nats-io/nats.go</code> + JetStream API</td></tr><tr><td>Pulsar provisioning</td><td>REST admin API via <code>net/http</code> to <code>arc-streaming:8080</code> (not binary protocol)</td></tr><tr><td>Postgres client</td><td><code>github.com/jackc/pgx/v5</code> pool</td></tr><tr><td>Redis client</td><td><code>github.com/go-redis/redis/v9</code></td></tr><tr><td>OTEL</td><td><code>go.opentelemetry.io/otel</code> — gRPC export to <code>arc-widow:4317</code></td></tr><tr><td>Concurrency</td><td><code>golang.org/x/sync/errgroup</code> for parallel phases</td></tr><tr><td>Circuit breaker</td><td><code>github.com/sony/gobreaker</code> — 3 failures → open, 30s reset</td></tr><tr><td>Testing</td><td><code>go test ./...</code> with table-driven tests; <code>testify</code> for assertions</td></tr><tr><td>Linting</td><td><code>golangci-lint run</code></td></tr></tbody></table><h3 id="dependency-notes" tabindex="-1">Dependency Notes <a class="header-anchor" href="#dependency-notes" aria-label="Permalink to &quot;Dependency Notes&quot;">​</a></h3><ul><li><strong>Pulsar admin</strong>: Provisioning (tenant, namespace, topic creation) uses the REST admin API at <code>:8080</code>, not the binary protocol at <code>:6650</code>. The binary service URL is stored in config for future producer/consumer use but unused in this feature.</li><li><strong>Circuit breaker per client</strong>: Each of the four infra clients gets its own <code>gobreaker.CircuitBreaker</code> instance — failure state is isolated so one flapping dependency doesn&#39;t open the breaker for others.</li><li><strong>Bootstrap idempotency</strong>: NATS stream <code>CreateStream</code> updates config if the stream already exists (no error). Pulsar topic creation is skipped silently if topic exists — implemented via a 409-check on the admin API response.</li></ul><hr><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h2><h3 id="component-overview" tabindex="-1">Component Overview <a class="header-anchor" href="#component-overview" aria-label="Permalink to &quot;Component Overview&quot;">​</a></h3>',15)),(s(),o(d,null,{default:t(()=>[n(i,{id:"mermaid-239",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20subgraph%20Triggers%0A%20%20%20%20%20%20%20%20CLI%5Bcortex%20bootstrap%5CnCobra%20CLI%5D%0A%20%20%20%20%20%20%20%20HTTP%5BPOST%20%2Fapi%2Fv1%2Fbootstrap%5CnGin%20API%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20Cortex%5B%22services%2Fcortex%2F%22%5D%0A%20%20%20%20%20%20%20%20Cobra%5Bcmd%2Fcortex%2Fbootstrap.go%5D%0A%20%20%20%20%20%20%20%20Gin%5Bcmd%2Fcortex%2Fserver.go%5D%0A%20%20%20%20%20%20%20%20Handler%5Binternal%2Fapi%2Fhandlers.go%5D%0A%20%20%20%20%20%20%20%20Orchestrator%5Binternal%2Forchestrator%2Fservice.go%5CnRunBootstrap%20%C2%B7%20RunDeepHealth%5D%0A%20%20%20%20%20%20%20%20Config%5Binternal%2Fconfig%2Fconfig.go%5CnViper%5D%0A%20%20%20%20%20%20%20%20Telemetry%5Binternal%2Ftelemetry%2Ffriday.go%5CnOTEL%20Provider%5D%0A%0A%20%20%20%20%20%20%20%20subgraph%20Clients%5B%22internal%2Fclients%2F%22%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20NATS%5Bnats.go%5Cn%2B%20circuit%20breaker%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Pulsar%5Bpulsar.go%5Cn%2B%20circuit%20breaker%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20PG%5Bpostgres.go%5Cn%2B%20circuit%20breaker%5D%0A%20%20%20%20%20%20%20%20%20%20%20%20Redis%5Bredis.go%5Cn%2B%20circuit%20breaker%5D%0A%20%20%20%20%20%20%20%20end%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20Infra%5B%22Infrastructure%22%5D%0A%20%20%20%20%20%20%20%20Flash%5B(arc-messaging%5CnNATS%20%3A4222)%5D%0A%20%20%20%20%20%20%20%20Strange%5B(arc-streaming%5CnPulsar%20%3A8080%20%2F%20%3A6650)%5D%0A%20%20%20%20%20%20%20%20Oracle%5B(arc-sql-db%5CnPG%20%3A5432)%5D%0A%20%20%20%20%20%20%20%20Sonic%5B(arc-cache%5CnRedis%20%3A6379)%5D%0A%20%20%20%20end%0A%0A%20%20%20%20subgraph%20Observability%5B%22Observability%22%5D%0A%20%20%20%20%20%20%20%20Widow%5Barc-friday-collector%5Cn%3A4317%20gRPC%5D%0A%20%20%20%20%20%20%20%20Friday%5Barc-friday%5CnSigNoz%5D%0A%20%20%20%20end%0A%0A%20%20%20%20CLI%20--%3E%20Cobra%20--%3E%20Orchestrator%0A%20%20%20%20HTTP%20--%3E%20Gin%20--%3E%20Handler%20--%3E%20Orchestrator%0A%20%20%20%20Orchestrator%20--%3E%20Config%0A%20%20%20%20Orchestrator%20--%3E%20Telemetry%0A%20%20%20%20Orchestrator%20--%3E%20NATS%20--%3E%20Flash%0A%20%20%20%20Orchestrator%20--%3E%20Pulsar%20--%3E%20Strange%0A%20%20%20%20Orchestrator%20--%3E%20PG%20--%3E%20Oracle%0A%20%20%20%20Orchestrator%20--%3E%20Redis%20--%3E%20Sonic%0A%20%20%20%20Telemetry%20-.-%3E%7COTLP%20gRPC%7C%20Widow%20-.-%3E%20Friday%0A%0A%20%20%20%20classDef%20core%20fill%3A%232b2d42%2Cstroke%3A%238d99ae%2Ccolor%3A%23fff%0A%20%20%20%20classDef%20infra%20fill%3A%23ef233c%2Cstroke%3A%232b2d42%2Ccolor%3A%23fff%0A%20%20%20%20classDef%20obs%20fill%3A%236d6875%2Cstroke%3A%232b2d42%2Ccolor%3A%23fff%0A%20%20%20%20class%20Orchestrator%2CConfig%2CTelemetry%20core%0A%20%20%20%20class%20Flash%2CStrange%2COracle%2CSonic%20infra%0A%20%20%20%20class%20Widow%2CFriday%20obs%0A"})]),fallback:t(()=>[...e[0]||(e[0]=[a(" Loading... ",-1)])]),_:1})),e[6]||(e[6]=r("h3",{id:"bootstrap-phase-sequence-parallel-execution",tabindex:"-1"},[a("Bootstrap Phase Sequence (Parallel Execution) "),r("a",{class:"header-anchor",href:"#bootstrap-phase-sequence-parallel-execution","aria-label":'Permalink to "Bootstrap Phase Sequence (Parallel Execution)"'},"​")],-1)),(s(),o(d,null,{default:t(()=>[n(i,{id:"mermaid-243",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20T%20as%20Trigger%20(HTTP%2FCLI)%0A%20%20%20%20participant%20O%20as%20Orchestrator%0A%20%20%20%20participant%20PG%20as%20arc-sql-db%0A%20%20%20%20participant%20N%20as%20arc-messaging%20(NATS)%0A%20%20%20%20participant%20P%20as%20arc-streaming%20(Pulsar)%0A%20%20%20%20participant%20R%20as%20arc-cache%20(Redis)%0A%20%20%20%20participant%20W%20as%20arc-widow%20(OTEL)%0A%0A%20%20%20%20T-%3E%3EO%3A%20RunBootstrap(ctx)%0A%20%20%20%20O-%3E%3EW%3A%20Start%20span%20%22cortex.bootstrap%22%0A%0A%20%20%20%20par%20Phase%201%20%E2%80%94%20Postgres%0A%20%20%20%20%20%20%20%20O-%3E%3EPG%3A%20ping%20%2B%20schema%20validate%0A%20%20%20%20%20%20%20%20PG--%3E%3EO%3A%20ok%0A%20%20%20%20and%20Phase%202%20%E2%80%94%20NATS%0A%20%20%20%20%20%20%20%20O-%3E%3EN%3A%20connect%20%2B%20create%203%20streams%0A%20%20%20%20%20%20%20%20N--%3E%3EO%3A%20streams%20ready%0A%20%20%20%20and%20Phase%203%20%E2%80%94%20Pulsar%0A%20%20%20%20%20%20%20%20O-%3E%3EP%3A%20create%20tenant%20%2B%203%20namespaces%20%2B%203%20topics%0A%20%20%20%20%20%20%20%20P--%3E%3EO%3A%20provisioned%0A%20%20%20%20and%20Phase%204%20%E2%80%94%20Redis%0A%20%20%20%20%20%20%20%20O-%3E%3ER%3A%20PING%0A%20%20%20%20%20%20%20%20R--%3E%3EO%3A%20PONG%0A%20%20%20%20end%0A%0A%20%20%20%20O-%3E%3EW%3A%20End%20span%20(success%2Ferror%20%2B%20phase%20durations)%0A%20%20%20%20O--%3E%3ET%3A%20BootstrapResult%7Bphases%3A%20%7Bpg%3Aok%2C%20nats%3Aok%2C%20pulsar%3Aok%2C%20redis%3Aok%7D%7D%0A"})]),fallback:t(()=>[...e[1]||(e[1]=[a(" Loading... ",-1)])]),_:1})),e[7]||(e[7]=r("h3",{id:"retry-circuit-breaker-flow-per-client",tabindex:"-1"},[a("Retry + Circuit Breaker Flow (per client) "),r("a",{class:"header-anchor",href:"#retry-circuit-breaker-flow-per-client","aria-label":'Permalink to "Retry + Circuit Breaker Flow (per client)"'},"​")],-1)),(s(),o(d,null,{default:t(()=>[n(i,{id:"mermaid-247",class:"mermaid",graph:"stateDiagram-v2%0A%20%20%20%20%5B*%5D%20--%3E%20Closed%0A%20%20%20%20Closed%20--%3E%20Open%3A%203%20consecutive%20failures%0A%20%20%20%20Open%20--%3E%20HalfOpen%3A%2030s%20elapsed%0A%20%20%20%20HalfOpen%20--%3E%20Closed%3A%20probe%20succeeds%0A%20%20%20%20HalfOpen%20--%3E%20Open%3A%20probe%20fails%0A%0A%20%20%20%20state%20Closed%20%7B%0A%20%20%20%20%20%20%20%20%5B*%5D%20--%3E%20Attempt%0A%20%20%20%20%20%20%20%20Attempt%20--%3E%20Success%3A%20ok%0A%20%20%20%20%20%20%20%20Attempt%20--%3E%20Backoff%3A%20error%0A%20%20%20%20%20%20%20%20Backoff%20--%3E%20Attempt%3A%202s%20%E2%86%92%204s%20%E2%86%92%208s%20%E2%80%A6%20max%2030s%5Cn(timeout%205m%20per%20phase)%0A%20%20%20%20%7D%0A"})]),fallback:t(()=>[...e[2]||(e[2]=[a(" Loading... ",-1)])]),_:1})),e[8]||(e[8]=r("h3",{id:"health-endpoint-behaviour",tabindex:"-1"},[a("Health Endpoint Behaviour "),r("a",{class:"header-anchor",href:"#health-endpoint-behaviour","aria-label":'Permalink to "Health Endpoint Behaviour"'},"​")],-1)),(s(),o(d,null,{default:t(()=>[n(i,{id:"mermaid-251",class:"mermaid",graph:"stateDiagram-v2%0A%20%20%20%20%5B*%5D%20--%3E%20Starting%0A%20%20%20%20Starting%20--%3E%20Ready%3A%20RunBootstrap()%20completes%0A%20%20%20%20Starting%20--%3E%20Ready%3A%20bootstrap%20fails%20(non-fatal)%0A%0A%20%20%20%20state%20Starting%20%7B%0A%20%20%20%20%20%20%20%20GET_health%3A%20%2Fhealth%20%E2%86%92%20200%20healthy%20(shallow)%0A%20%20%20%20%20%20%20%20GET_ready%3A%20%2Fready%20%E2%86%92%20503%20not-ready%0A%20%20%20%20%20%20%20%20POST_bootstrap%3A%20POST%20%2Fapi%2Fv1%2Fbootstrap%20%E2%86%92%20409%20if%20already%20running%0A%20%20%20%20%7D%0A%20%20%20%20state%20Ready%20%7B%0A%20%20%20%20%20%20%20%20GET_health2%3A%20%2Fhealth%20%E2%86%92%20200%20healthy%0A%20%20%20%20%20%20%20%20GET_ready2%3A%20%2Fready%20%E2%86%92%20200%20ok%0A%20%20%20%20%20%20%20%20GET_deep%3A%20%2Fhealth%2Fdeep%20%E2%86%92%20200%2F503%20per%20dep%20probe%0A%20%20%20%20%20%20%20%20Monitor%3A%20background%20goroutine%20probes%20every%2030s%0A%20%20%20%20%7D%0A"})]),fallback:t(()=>[...e[3]||(e[3]=[a(" Loading... ",-1)])]),_:1})),e[9]||(e[9]=l(`<hr><h2 id="constitution-check" tabindex="-1">Constitution Check <a class="header-anchor" href="#constitution-check" aria-label="Permalink to &quot;Constitution Check&quot;">​</a></h2><table tabindex="0"><thead><tr><th>#</th><th>Principle</th><th>Status</th><th>Evidence</th></tr></thead><tbody><tr><td>I</td><td>Zero-Dep CLI</td><td>N/A</td><td>Service, not CLI binary</td></tr><tr><td>II</td><td>Platform-in-a-Box</td><td><strong>PASS</strong></td><td><code>docker compose up cortex</code> bootstraps all infra automatically</td></tr><tr><td>III</td><td>Modular Services</td><td><strong>PASS</strong></td><td>Self-contained in <code>services/cortex/</code>; <code>service.yaml</code> declares all deps</td></tr><tr><td>IV</td><td>Two-Brain</td><td><strong>PASS</strong></td><td>Pure Go — infrastructure orchestration only; no Python</td></tr><tr><td>V</td><td>Polyglot Standards</td><td><strong>PASS</strong></td><td>golangci-lint, <code>slog</code>, table-driven tests, 12-factor config via Viper</td></tr><tr><td>VI</td><td>Local-First</td><td>N/A</td><td>Service, not CLI</td></tr><tr><td>VII</td><td>Observability</td><td><strong>PASS</strong></td><td>OTEL traces + metrics from day one; <code>/health</code> + <code>/health/deep</code></td></tr><tr><td>VIII</td><td>Security</td><td><strong>PASS</strong></td><td>Non-root <code>USER cortex</code> in Dockerfile; no secrets in logs</td></tr><tr><td>IX</td><td>Declarative</td><td>N/A</td><td>Not a reconciler</td></tr><tr><td>X</td><td>Stateful Ops</td><td>N/A</td><td>Not a CLI</td></tr><tr><td>XI</td><td>Resilience</td><td><strong>PASS</strong></td><td>Circuit breakers + exponential backoff on all four infra clients</td></tr><tr><td>XII</td><td>Interactive</td><td>N/A</td><td>Not a CLI TUI</td></tr></tbody></table><hr><h2 id="project-structure" tabindex="-1">Project Structure <a class="header-anchor" href="#project-structure" aria-label="Permalink to &quot;Project Structure&quot;">​</a></h2><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>arc-platform/</span></span>
<span class="line"><span>├── services/</span></span>
<span class="line"><span>│   ├── cortex/</span></span>
<span class="line"><span>│   │   ├── cmd/</span></span>
<span class="line"><span>│   │   │   └── cortex/</span></span>
<span class="line"><span>│   │   │       ├── main.go             # Wire AppContext, start actor group</span></span>
<span class="line"><span>│   │   │       ├── root.go             # Cobra root + global flags (--config, --log-level)</span></span>
<span class="line"><span>│   │   │       ├── server.go           # \`cortex server\` — start Gin API on :8081</span></span>
<span class="line"><span>│   │   │       └── bootstrap.go        # \`cortex bootstrap\` — one-shot CLI; exit 0/1</span></span>
<span class="line"><span>│   │   ├── internal/</span></span>
<span class="line"><span>│   │   │   ├── api/</span></span>
<span class="line"><span>│   │   │   │   ├── server.go           # Gin router wiring + graceful shutdown</span></span>
<span class="line"><span>│   │   │   │   ├── handlers.go         # /bootstrap, /health, /health/deep, /ready handlers</span></span>
<span class="line"><span>│   │   │   │   └── middleware.go       # OTEL trace propagation + panic recovery</span></span>
<span class="line"><span>│   │   │   ├── orchestrator/</span></span>
<span class="line"><span>│   │   │   │   ├── service.go          # RunBootstrap(), RunDeepHealth() — errgroup parallel phases</span></span>
<span class="line"><span>│   │   │   │   └── types.go            # BootstrapResult, PhaseResult, ProbeResult</span></span>
<span class="line"><span>│   │   │   ├── clients/</span></span>
<span class="line"><span>│   │   │   │   ├── nats.go             # JetStream stream creation + gobreaker</span></span>
<span class="line"><span>│   │   │   │   ├── pulsar.go           # Pulsar admin REST + gobreaker</span></span>
<span class="line"><span>│   │   │   │   ├── postgres.go         # pgx pool ping + schema check + gobreaker</span></span>
<span class="line"><span>│   │   │   │   └── redis.go            # go-redis PING + gobreaker</span></span>
<span class="line"><span>│   │   │   ├── config/</span></span>
<span class="line"><span>│   │   │   │   └── config.go           # Root Viper config; typed structs per section</span></span>
<span class="line"><span>│   │   │   └── telemetry/</span></span>
<span class="line"><span>│   │   │       └── friday.go           # OTEL TracerProvider + MeterProvider → arc-widow:4317</span></span>
<span class="line"><span>│   │   ├── service.yaml                # codename: cortex; deps; health endpoint</span></span>
<span class="line"><span>│   │   ├── Dockerfile                  # Non-root USER cortex; multi-stage build</span></span>
<span class="line"><span>│   │   ├── go.mod</span></span>
<span class="line"><span>│   │   └── go.sum</span></span>
<span class="line"><span>│   └── profiles.yaml                   # Add cortex to think + reason profiles</span></span>
<span class="line"><span>├── .specify/</span></span>
<span class="line"><span>│   ├── config.yaml                     # Update bootstrap → cortex entry</span></span>
<span class="line"><span>│   ├── meta/</span></span>
<span class="line"><span>│   │   └── service-codename-map.md     # Add Cortex row</span></span>
<span class="line"><span>│   └── docs/</span></span>
<span class="line"><span>│       └── architecture/</span></span>
<span class="line"><span>│           └── cortex.md               # Architecture doc</span></span></code></pre></div><hr><h2 id="parallel-execution-strategy" tabindex="-1">Parallel Execution Strategy <a class="header-anchor" href="#parallel-execution-strategy" aria-label="Permalink to &quot;Parallel Execution Strategy&quot;">​</a></h2>`,8)),(s(),o(d,null,{default:t(()=>[n(i,{id:"mermaid-453",class:"mermaid",graph:"gantt%0A%20%20%20%20title%20Cortex%20Implementation%20Phases%0A%20%20%20%20dateFormat%20%20YYYY-MM-DD%0A%20%20%20%20axisFormat%20%20Day%20%25d%0A%0A%20%20%20%20section%20Phase%201%20%E2%80%94%20Foundation%20(sequential%2C%20one%20agent)%0A%20%20%20%20go.mod%20%2B%20module%20scaffold%20%20%20%20%20%20%20%20%20%20%20%3Ap1a%2C%202026-02-22%2C%201d%0A%20%20%20%20Config%20(Viper%20structs%20%2B%20env%20map)%20%20%20%3Ap1b%2C%20after%20p1a%2C%201d%0A%20%20%20%20Telemetry%20(OTEL%20provider%20friday.go)%3Ap1c%2C%20after%20p1b%2C%201d%0A%20%20%20%20Cobra%20root%20%2B%20server%2Fbootstrap%20cmds%20%3Ap1d%2C%20after%20p1c%2C%201d%0A%0A%20%20%20%20section%20Phase%202%20%E2%80%94%20Parallel%20(4%20agents)%0A%20%20%20%20Client%3A%20NATS%20(nats.go%20%2B%20tests)%20%20%20%20%20%3Ap2a%2C%20after%20p1d%2C%202d%0A%20%20%20%20Client%3A%20Pulsar%20(pulsar.go%20%2B%20tests)%20%3Ap2b%2C%20after%20p1d%2C%202d%0A%20%20%20%20Client%3A%20Postgres%20(postgres.go%20%2B%20tests)%20%3Ap2c%2C%20after%20p1d%2C%202d%0A%20%20%20%20Client%3A%20Redis%20(redis.go%20%2B%20tests)%20%20%20%3Ap2d%2C%20after%20p1d%2C%201d%0A%0A%20%20%20%20section%20Phase%203%20%E2%80%94%20Integration%20(sequential)%0A%20%20%20%20Orchestrator%20(service.go%20%2B%20types.go)%3Ap3a%2C%20after%20p2a%2C%202d%0A%20%20%20%20API%20layer%20(server%2Fhandlers%2Fmiddleware)%3Ap3b%2C%20after%20p3a%2C%201d%0A%20%20%20%20Dockerfile%20%2B%20service.yaml%20%20%20%20%20%20%20%20%20%20%3Ap3c%2C%20after%20p3b%2C%201d%0A%0A%20%20%20%20section%20Phase%204%20%E2%80%94%20Wiring%20%26%20Validation%0A%20%20%20%20main.go%20DI%20wiring%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%3Ap4a%2C%20after%20p3c%2C%201d%0A%20%20%20%20Integration%20%2B%20health%20endpoint%20tests%20%3Ap4b%2C%20after%20p4a%2C%201d%0A%20%20%20%20Docs%20%2B%20config.yaml%20%2B%20profiles.yaml%20%3Ap4c%2C%20after%20p3c%2C%201d%0A"})]),fallback:t(()=>[...e[4]||(e[4]=[a(" Loading... ",-1)])]),_:1})),e[10]||(e[10]=l('<h3 id="parallelisation-notes" tabindex="-1">Parallelisation Notes <a class="header-anchor" href="#parallelisation-notes" aria-label="Permalink to &quot;Parallelisation Notes&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Group</th><th>Tasks</th><th>Parallel?</th><th>Dependency</th></tr></thead><tbody><tr><td>A</td><td>4 infra clients (nats, pulsar, postgres, redis)</td><td><strong>YES</strong> — independent packages</td><td>Phase 1 complete</td></tr><tr><td>B</td><td>Orchestrator + API layer</td><td><strong>NO</strong> — orchestrator uses all 4 clients</td><td>Group A complete</td></tr><tr><td>C</td><td>Docs/config updates</td><td><strong>YES</strong> — no code dependency</td><td>Phase 3 started</td></tr><tr><td>D</td><td>main.go wiring</td><td><strong>NO</strong> — needs orchestrator + API</td><td>Group B complete</td></tr></tbody></table><hr><h2 id="key-design-decisions" tabindex="-1">Key Design Decisions <a class="header-anchor" href="#key-design-decisions" aria-label="Permalink to &quot;Key Design Decisions&quot;">​</a></h2><h3 id="_1-phase-parallelism-via-errgroup" tabindex="-1">1. Phase parallelism via <code>errgroup</code> <a class="header-anchor" href="#_1-phase-parallelism-via-errgroup" aria-label="Permalink to &quot;1. Phase parallelism via `errgroup`&quot;">​</a></h3><div class="language-go vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">go</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span style="--shiki-light:#6A737D;--shiki-dark:#6A737D;">// internal/orchestrator/service.go</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g, ctx </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">:=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> errgroup.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">WithContext</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx)</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Go</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runPostgresPhase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, result) })</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Go</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runNATSPhase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, result) })</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Go</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runPulsarPhase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, result) })</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">g.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Go</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(</span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">func</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">() </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">error</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> { </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">return</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> s.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">runRedisPhase</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">(ctx, result) })</span></span>\n<span class="line"><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">err </span><span style="--shiki-light:#D73A49;--shiki-dark:#F97583;">=</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;"> g.</span><span style="--shiki-light:#6F42C1;--shiki-dark:#B392F0;">Wait</span><span style="--shiki-light:#24292E;--shiki-dark:#E1E4E8;">()</span></span></code></pre></div><p>Each phase writes to <code>result</code> under a <code>sync.Mutex</code>. Phase-level error does not cancel other phases — <code>errgroup</code> collects all errors.</p><h3 id="_2-circuit-breaker-per-client" tabindex="-1">2. Circuit breaker per client <a class="header-anchor" href="#_2-circuit-breaker-per-client" aria-label="Permalink to &quot;2. Circuit breaker per client&quot;">​</a></h3><p>Each client embeds a <code>gobreaker.CircuitBreaker</code> configured as:</p><ul><li><code>MaxRequests</code>: 1 (probe in half-open)</li><li><code>Interval</code>: 0 (count window = open duration)</li><li><code>Timeout</code>: 30s (open → half-open)</li><li><code>ReadyToTrip</code>: trips after 3 consecutive failures</li></ul><h3 id="_3-post-api-v1-bootstrap-concurrency-guard" tabindex="-1">3. <code>POST /api/v1/bootstrap</code> concurrency guard <a class="header-anchor" href="#_3-post-api-v1-bootstrap-concurrency-guard" aria-label="Permalink to &quot;3. `POST /api/v1/bootstrap` concurrency guard&quot;">​</a></h3><p>An <code>atomic.Bool</code> (<code>bootstrapInProgress</code>) gates concurrent bootstrap requests — returns <code>409</code> immediately if a bootstrap is already running.</p><h3 id="_4-pulsar-admin-via-rest-not-binary-client" tabindex="-1">4. Pulsar admin via REST, not binary client <a class="header-anchor" href="#_4-pulsar-admin-via-rest-not-binary-client" aria-label="Permalink to &quot;4. Pulsar admin via REST, not binary client&quot;">​</a></h3><p>Tenant/namespace/topic creation uses <code>http.Post</code> to <code>PULSAR_ADMIN_URL</code>. A 409 response on topic creation is treated as success (idempotent). The binary <code>PULSAR_SERVICE_URL</code> is stored in config for future use.</p><h3 id="_5-ready-lifecycle" tabindex="-1">5. <code>/ready</code> lifecycle <a class="header-anchor" href="#_5-ready-lifecycle" aria-label="Permalink to &quot;5. `/ready` lifecycle&quot;">​</a></h3><p><code>/ready</code> returns <code>503</code> until <code>bootstrapInProgress</code> flips false AND <code>bootstrapCompleted</code> is true. This enables Traefik to withhold traffic until infra is fully provisioned.</p><hr><h2 id="reviewer-checklist" tabindex="-1">Reviewer Checklist <a class="header-anchor" href="#reviewer-checklist" aria-label="Permalink to &quot;Reviewer Checklist&quot;">​</a></h2><ul><li>[ ] All tasks in <code>tasks.md</code> marked completed</li><li>[ ] <code>go test ./...</code> passes with ≥ 75% coverage on <code>internal/orchestrator</code> and <code>internal/clients</code></li><li>[ ] <code>go test ./...</code> passes with ≥ 60% coverage on <code>internal/api</code></li><li>[ ] <code>golangci-lint run</code> produces zero errors</li><li>[ ] <code>GET /health</code> responds in &lt; 50ms (manual curl check)</li><li>[ ] <code>docker inspect</code> confirms non-root user (<code>cortex</code>)</li><li>[ ] Constitution check: all REQUIRED principles verified (II, III, IV, V, VII, VIII, XI)</li><li>[ ] All four NATS streams created with correct config (subjects, retention, max-age)</li><li>[ ] All Pulsar resources provisioned (tenant <code>arc-system</code>, 3 namespaces, 3 partitioned topics)</li><li>[ ] <code>POST /api/v1/bootstrap</code> returns <code>409</code> when called while bootstrap in progress</li><li>[ ] <code>cortex bootstrap</code> CLI exits 0 on success, non-zero on failure</li><li>[ ] OTEL traces visible in arc-friday under service name <code>arc-cortex</code></li><li>[ ] <code>services/profiles.yaml</code> includes <code>cortex</code> in <code>think</code> and <code>reason</code></li><li>[ ] <code>service.yaml</code> declares correct <code>depends_on: [flash, strange, oracle, sonic, widow]</code></li><li>[ ] <code>.specify/config.yaml</code> updated from <code>bootstrap/raymond</code> → <code>cortex/cortex</code></li><li>[ ] No secrets, passwords, or credentials appear in logs or error responses</li></ul><hr><h2 id="risks-mitigations" tabindex="-1">Risks &amp; Mitigations <a class="header-anchor" href="#risks-mitigations" aria-label="Permalink to &quot;Risks &amp; Mitigations&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Risk</th><th>Impact</th><th>Mitigation</th></tr></thead><tbody><tr><td>Pulsar REST admin API has different error shapes across versions</td><td>M</td><td>Defensive JSON parsing; log raw response on unexpected status</td></tr><tr><td><code>errgroup</code> phase error masks partial success</td><td>M</td><td><code>BootstrapResult</code> stores per-phase status independently; errgroup collects all, doesn&#39;t cancel on first error</td></tr><tr><td>OTEL gRPC dial failure blocks startup</td><td>H</td><td>Use <code>WithFailFast(false)</code> + async export; bootstrap proceeds regardless of OTEL availability</td></tr><tr><td>pgx pool exhausted under concurrent <code>/health/deep</code> calls</td><td>L</td><td>Pool max connections capped; <code>/health/deep</code> uses single probe connection with short timeout</td></tr><tr><td><code>service.yaml</code> <code>depends_on</code> not yet enforced by arc CLI</td><td>L</td><td>Document in README; CLI enforcement is out-of-scope for this feature</td></tr></tbody></table>',22))])}const C=c(g,[["render",u]]);export{y as __pageData,C as default};
