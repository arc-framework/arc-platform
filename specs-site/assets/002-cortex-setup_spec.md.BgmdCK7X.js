import{_ as i,C as l,o,c as p,an as r,b as s,w as t,a as d,E as n,ao as c}from"./chunks/framework.CTqRDTHW.js";const A=JSON.parse('{"title":"Feature: Cortex Bootstrap Service","description":"","frontmatter":{},"headers":[],"relativePath":"002-cortex-setup/spec.md","filePath":"002-cortex-setup/spec.md","lastUpdated":1772310733000}'),u={name:"002-cortex-setup/spec.md"};function h(g,e,m,f,b,q){const a=l("Mermaid");return o(),p("div",null,[e[2]||(e[2]=r('<p>&lt;div style=&quot;display: none;&quot; hidden=&quot;true&quot; aria-hidden=&quot;true&quot;&gt;Are you an LLM? You can read better optimized documentation at /arc-platform/specs-site/002-cortex-setup/spec.md for this page in Markdown format&lt;/div&gt;</p><h1 id="feature-cortex-bootstrap-service" tabindex="-1">Feature: Cortex Bootstrap Service <a class="header-anchor" href="#feature-cortex-bootstrap-service" aria-label="Permalink to &quot;Feature: Cortex Bootstrap Service&quot;">​</a></h1><blockquote><p><strong>Spec</strong>: 002-cortex-setup <strong>Author</strong>: arc-team <strong>Date</strong>: 2026-02-22 <strong>Status</strong>: Draft</p></blockquote><h2 id="target-modules" tabindex="-1">Target Modules <a class="header-anchor" href="#target-modules" aria-label="Permalink to &quot;Target Modules&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Module</th><th>Path</th><th>Impact</th></tr></thead><tbody><tr><td>Services</td><td><code>services/cortex/</code></td><td>New service — Cortex bootstrap orchestrator (Go)</td></tr><tr><td>Docs</td><td><code>docs/</code></td><td>Add Cortex to the platform service catalogue</td></tr></tbody></table><h2 id="overview" tabindex="-1">Overview <a class="header-anchor" href="#overview" aria-label="Permalink to &quot;Overview&quot;">​</a></h2><p>Cortex (<code>services/cortex/</code>, codename: <code>cortex</code>) is the A.R.C. platform bootstrap service — the spark plug that provisions all infrastructure at startup. The <strong>primary interface is HTTP</strong>: Heimdall (Traefik) routes <code>POST /api/v1/bootstrap</code> to Cortex&#39;s Gin API, which delegates to the Orchestrator Core. A Cobra CLI command (<code>cortex bootstrap</code>) is a secondary trigger for direct operator use. Cortex provisions NATS JetStream streams, Pulsar tenants and topics, validates the Postgres schema, and verifies Redis connectivity. All activity is traced and metered via the Friday OTEL stack.</p><h2 id="architecture" tabindex="-1">Architecture <a class="header-anchor" href="#architecture" aria-label="Permalink to &quot;Architecture&quot;">​</a></h2>',8)),(o(),s(c,null,{default:t(()=>[n(a,{id:"mermaid-62",class:"mermaid",graph:"graph%20TD%0A%20%20%20%20%25%25%20Inputs%20%E2%80%94%20API%20is%20primary%0A%20%20%20%20Gateway%5BHeimdall%20%2F%20Traefik%5D%20--%3E%7CHTTP%20POST%20%2Fapi%2Fv1%2Fbootstrap%7C%20Gin%5BGin%20API%20Adapter%5Cninternal%2Fapi%5D%0A%20%20%20%20CLI%5Barc%20CLI%20%2F%20Dev%20Terminal%5D%20-.-%3E%7Ccortex%20bootstrap%7C%20Cobra%5BCobra%20CLI%20Adapter%5Cncmd%2Fcortex%5D%0A%0A%20%20%20%20%25%25%20Core%20%E2%80%94%20Hexagonal%0A%20%20%20%20subgraph%20Cortex%20%5BCortex%20Service%20%E2%80%94%20services%2Fcortex%2F%5D%0A%20%20%20%20%20%20%20%20Gin%20--%3E%20Core%5BOrchestrator%20Core%5Cninternal%2Forchestrator%5D%0A%20%20%20%20%20%20%20%20Cobra%20--%3E%20Core%0A%0A%20%20%20%20%20%20%20%20Core%20--%3E%20NATSClient%5BNATS%20Client%5Cninternal%2Fclients%2Fnats.go%5D%0A%20%20%20%20%20%20%20%20Core%20--%3E%20PulsarClient%5BPulsar%20Client%5Cninternal%2Fclients%2Fpulsar.go%5D%0A%20%20%20%20%20%20%20%20Core%20--%3E%20DBClient%5BPostgres%20Client%5Cninternal%2Fclients%2Fpostgres.go%5D%0A%20%20%20%20%20%20%20%20Core%20--%3E%20RedisClient%5BRedis%20Client%5Cninternal%2Fclients%2Fredis.go%5D%0A%20%20%20%20%20%20%20%20Core%20--%3E%20Otel%5BTelemetry%20Module%5Cninternal%2Ftelemetry%2Ffriday.go%5D%0A%20%20%20%20end%0A%0A%20%20%20%20%25%25%20Infrastructure%0A%20%20%20%20NATSClient%20--%3E%7CCreate%20Streams%7C%20Flash%5B(arc-messaging%5CnNATS%20JetStream%20%3A4222)%5D%0A%20%20%20%20PulsarClient%20--%3E%7CCreate%20Tenant%20%2B%20Topics%7C%20Strange%5B(arc-streaming%5CnPulsar%20%3A8080%20%2F%20%3A6650)%5D%0A%20%20%20%20DBClient%20--%3E%7CPing%20%26%20Migrate%7C%20Oracle%5B(arc-sql-db%5CnPostgres%20%3A5432)%5D%0A%20%20%20%20RedisClient%20--%3E%7CPing%20%26%20Verify%7C%20Sonic%5B(arc-cache%5CnRedis%20%3A6379)%5D%0A%0A%20%20%20%20%25%25%20Observability%0A%20%20%20%20Otel%20-.-%3E%7COTLP%20gRPC%20%3A4317%7C%20Collector%5Barc-friday-collector%5D%0A%20%20%20%20Collector%20-.-%3E%7CAll%20Signals%7C%20ArcFriday%5Barc-friday%3A%20SigNoz%5D%0A%20%20%20%20ArcFriday%20-.-%3E%7CStorage%7C%20ClickHouse%5B(ClickHouse)%5D%0A%0A%20%20%20%20classDef%20core%20fill%3A%232b2d42%2Cstroke%3A%238d99ae%2Cstroke-width%3A2px%2Ccolor%3A%23fff%0A%20%20%20%20classDef%20infra%20fill%3A%23ef233c%2Cstroke%3A%232b2d42%2Cstroke-width%3A2px%2Ccolor%3A%23fff%0A%20%20%20%20classDef%20obs%20fill%3A%238d99ae%2Cstroke%3A%232b2d42%2Cstroke-width%3A2px%2Ccolor%3A%23fff%0A%20%20%20%20classDef%20storage%20fill%3A%236d6875%2Cstroke%3A%232b2d42%2Cstroke-width%3A2px%2Ccolor%3A%23fff%0A%0A%20%20%20%20class%20Cortex%20core%0A%20%20%20%20class%20Flash%2CStrange%2COracle%2CSonic%20infra%0A%20%20%20%20class%20Collector%2CArcFriday%20obs%0A%20%20%20%20class%20ClickHouse%20storage%0A"})]),fallback:t(()=>[...e[0]||(e[0]=[d(" Loading... ",-1)])]),_:1})),e[3]||(e[3]=r(`<h3 id="directory-structure" tabindex="-1">Directory Structure <a class="header-anchor" href="#directory-structure" aria-label="Permalink to &quot;Directory Structure&quot;">​</a></h3><p>Strict Go project layout — no dumping everything in <code>main.go</code>.</p><div class="language-text vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang">text</span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>services/cortex/</span></span>
<span class="line"><span>├── cmd/</span></span>
<span class="line"><span>│   └── cortex/</span></span>
<span class="line"><span>│       ├── main.go             # Wire dependencies here</span></span>
<span class="line"><span>│       ├── root.go             # Cobra root command</span></span>
<span class="line"><span>│       ├── server.go           # \`cortex server\` — start Gin API</span></span>
<span class="line"><span>│       └── bootstrap.go        # \`cortex bootstrap\` — one-shot CLI execution</span></span>
<span class="line"><span>├── internal/</span></span>
<span class="line"><span>│   ├── api/                    # HTTP Transport Adapter</span></span>
<span class="line"><span>│   │   ├── server.go           # Gin router setup</span></span>
<span class="line"><span>│   │   ├── handlers.go         # HTTP handlers calling orchestrator</span></span>
<span class="line"><span>│   │   └── middleware.go       # Friday (OTEL) &amp; Recovery middlewares</span></span>
<span class="line"><span>│   ├── orchestrator/           # Core Domain Logic (The Brain)</span></span>
<span class="line"><span>│   │   ├── service.go          # RunBootstrap(), RunDeepHealth()</span></span>
<span class="line"><span>│   │   └── types.go            # BootstrapResult, PhaseResult, ProbeResult</span></span>
<span class="line"><span>│   ├── clients/                # Infrastructure Adapters</span></span>
<span class="line"><span>│   │   ├── nats.go             # NATS JetStream setup + circuit breaker</span></span>
<span class="line"><span>│   │   ├── pulsar.go           # Pulsar tenant/namespace/topic setup + circuit breaker</span></span>
<span class="line"><span>│   │   ├── postgres.go         # pgx pool + schema validation + circuit breaker</span></span>
<span class="line"><span>│   │   └── redis.go            # go-redis ping + circuit breaker</span></span>
<span class="line"><span>│   ├── config/</span></span>
<span class="line"><span>│   │   └── config.go           # Viper/Infisical bindings</span></span>
<span class="line"><span>│   └── telemetry/</span></span>
<span class="line"><span>│       └── friday.go           # OTEL provider — traces + metrics → arc-friday-collector</span></span>
<span class="line"><span>├── service.yaml                # codename: cortex, depends_on, health endpoint</span></span>
<span class="line"><span>├── Dockerfile</span></span>
<span class="line"><span>├── go.mod</span></span>
<span class="line"><span>└── go.sum</span></span></code></pre></div><h3 id="http-api" tabindex="-1">HTTP API <a class="header-anchor" href="#http-api" aria-label="Permalink to &quot;HTTP API&quot;">​</a></h3><p>The Gin router is the primary interface. All routes are under the Cortex server (<code>cortex server</code>):</p><table tabindex="0"><thead><tr><th>Method</th><th>Path</th><th>Handler</th><th>Auth</th><th>Description</th></tr></thead><tbody><tr><td><code>POST</code></td><td><code>/api/v1/bootstrap</code></td><td><code>handlers.Bootstrap</code></td><td>—</td><td>Trigger full platform bootstrap</td></tr><tr><td><code>GET</code></td><td><code>/health</code></td><td><code>handlers.Health</code></td><td>—</td><td>Shallow health — always 200</td></tr><tr><td><code>GET</code></td><td><code>/health/deep</code></td><td><code>handlers.DeepHealth</code></td><td>—</td><td>Deep probe — calls <code>RunDeepHealth()</code></td></tr><tr><td><code>GET</code></td><td><code>/ready</code></td><td><code>handlers.Ready</code></td><td>—</td><td>Readiness — 503 until bootstrap complete</td></tr></tbody></table><p><strong>Middleware chain</strong> (applied in order):</p><ol><li><code>middleware.Recovery(logger)</code> — panic → 500, log stack, continue</li><li><code>middleware.FridayOTEL(&quot;arc-cortex&quot;)</code> — inject trace context per request (otelgin)</li><li><code>middleware.RequestLogger(logger)</code> — structured request/response logging</li></ol><p><strong>Bootstrap request/response:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>POST /api/v1/bootstrap</span></span>
<span class="line"><span>→ 200 {&quot;status&quot;:&quot;ok&quot;,&quot;phases&quot;:{&quot;postgres&quot;:&quot;ok&quot;,&quot;nats&quot;:&quot;ok&quot;,&quot;pulsar&quot;:&quot;ok&quot;,&quot;redis&quot;:&quot;ok&quot;}}</span></span>
<span class="line"><span>→ 409 {&quot;status&quot;:&quot;in-progress&quot;}           (if already running)</span></span>
<span class="line"><span>→ 500 {&quot;status&quot;:&quot;error&quot;,&quot;phase&quot;:&quot;nats&quot;,&quot;error&quot;:&quot;...&quot;}</span></span></code></pre></div><p><strong>Deep health response:</strong></p><div class="language- vp-adaptive-theme"><button title="Copy Code" class="copy"></button><span class="lang"></span><pre class="shiki shiki-themes github-light github-dark vp-code" tabindex="0"><code><span class="line"><span>GET /health/deep</span></span>
<span class="line"><span>→ 200 {&quot;status&quot;:&quot;healthy&quot;,&quot;dependencies&quot;:{</span></span>
<span class="line"><span>    &quot;arc-sql-db&quot;: {&quot;ok&quot;:true,&quot;latencyMs&quot;:2,&quot;error&quot;:&quot;&quot;},</span></span>
<span class="line"><span>    &quot;arc-messaging&quot;:  {&quot;ok&quot;:true,&quot;latencyMs&quot;:1,&quot;error&quot;:&quot;&quot;},</span></span>
<span class="line"><span>    &quot;arc-streaming&quot;:{&quot;ok&quot;:true,&quot;latencyMs&quot;:5,&quot;error&quot;:&quot;&quot;},</span></span>
<span class="line"><span>    &quot;arc-cache&quot;:  {&quot;ok&quot;:true,&quot;latencyMs&quot;:1,&quot;error&quot;:&quot;&quot;}</span></span>
<span class="line"><span>  }}</span></span>
<span class="line"><span>→ 503  (same shape, &quot;ok&quot;:false on failing deps)</span></span></code></pre></div><h3 id="bootstrap-phase-sequence" tabindex="-1">Bootstrap Phase Sequence <a class="header-anchor" href="#bootstrap-phase-sequence" aria-label="Permalink to &quot;Bootstrap Phase Sequence&quot;">​</a></h3>`,13)),(o(),s(c,null,{default:t(()=>[n(a,{id:"mermaid-198",class:"mermaid",graph:"sequenceDiagram%0A%20%20%20%20participant%20GW%20as%20Heimdall%20%2F%20CLI%0A%20%20%20%20participant%20API%20as%20Gin%20API%20(handlers.Bootstrap)%0A%20%20%20%20participant%20Core%20as%20Orchestrator%20(RunBootstrap)%0A%20%20%20%20participant%20PG%20as%20arc-sql-db%0A%20%20%20%20participant%20NATS%20as%20arc-messaging%0A%20%20%20%20participant%20Pulsar%20as%20arc-streaming%0A%20%20%20%20participant%20Redis%20as%20arc-cache%0A%20%20%20%20participant%20Friday%20as%20arc-friday-collector%0A%0A%20%20%20%20GW-%3E%3EAPI%3A%20POST%20%2Fapi%2Fv1%2Fbootstrap%0A%20%20%20%20API-%3E%3ECore%3A%20RunBootstrap(ctx)%0A%20%20%20%20Core-%3E%3EFriday%3A%20Span%20Start%20%E2%80%94%20%22platform.bootstrap%22%0A%0A%20%20%20%20par%20Phase%201%0A%20%20%20%20%20%20%20%20Core-%3E%3EPG%3A%20Ping%20%26%20Check%20Migrations%0A%20%20%20%20%20%20%20%20PG--%3E%3ECore%3A%20OK%0A%20%20%20%20and%20Phase%202%0A%20%20%20%20%20%20%20%20Core-%3E%3ENATS%3A%20CreateStream(AGENT_COMMANDS)%0A%20%20%20%20%20%20%20%20Core-%3E%3ENATS%3A%20CreateStream(AGENT_EVENTS)%0A%20%20%20%20%20%20%20%20Core-%3E%3ENATS%3A%20CreateStream(SYSTEM_METRICS)%0A%20%20%20%20%20%20%20%20NATS--%3E%3ECore%3A%20Streams%20ready%0A%20%20%20%20and%20Phase%203%0A%20%20%20%20%20%20%20%20Core-%3E%3EPulsar%3A%20Create%20tenant%20arc-system%0A%20%20%20%20%20%20%20%20Core-%3E%3EPulsar%3A%20Create%20namespaces%20%2B%20topics%0A%20%20%20%20%20%20%20%20Pulsar--%3E%3ECore%3A%20Provisioned%0A%20%20%20%20and%20Phase%204%0A%20%20%20%20%20%20%20%20Core-%3E%3ERedis%3A%20Ping%0A%20%20%20%20%20%20%20%20Redis--%3E%3ECore%3A%20PONG%0A%20%20%20%20end%0A%0A%20%20%20%20Core-%3E%3EFriday%3A%20Span%20End%20%E2%80%94%20success%0A%20%20%20%20Core--%3E%3EAPI%3A%20BootstrapResult%7Bphases%3A%20all%20ok%7D%0A%20%20%20%20API--%3E%3EGW%3A%20200%20OK%0A"})]),fallback:t(()=>[...e[1]||(e[1]=[d(" Loading... ",-1)])]),_:1})),e[4]||(e[4]=r('<h2 id="libraries" tabindex="-1">Libraries <a class="header-anchor" href="#libraries" aria-label="Permalink to &quot;Libraries&quot;">​</a></h2><p>Per the A.R.C. Go Standard (<code>cortex.md</code> §4):</p><table tabindex="0"><thead><tr><th>Concern</th><th>Library</th></tr></thead><tbody><tr><td>CLI</td><td><code>github.com/spf13/cobra</code></td></tr><tr><td>Configuration</td><td><code>github.com/spf13/viper</code></td></tr><tr><td>HTTP Router</td><td><code>github.com/gin-gonic/gin</code></td></tr><tr><td>OTEL middleware</td><td><code>go.opentelemetry.io/contrib/instrumentation/github.com/gin-gonic/gin/otelgin</code></td></tr><tr><td>Logging</td><td><code>log/slog</code> (stdlib)</td></tr><tr><td>Telemetry</td><td><code>go.opentelemetry.io/otel</code> + <code>otlptracegrpc</code> + <code>otlpmetricgrpc</code></td></tr><tr><td>PostgreSQL</td><td><code>github.com/jackc/pgx/v5</code></td></tr><tr><td>NATS</td><td><code>github.com/nats-io/nats.go</code></td></tr><tr><td>Pulsar</td><td><code>github.com/apache/pulsar-client-go/pulsar</code></td></tr><tr><td>Redis</td><td><code>github.com/redis/go-redis/v9</code></td></tr><tr><td>Secrets</td><td>Infisical Go SDK (<code>github.com/infisical/go-sdk</code>) — or Viper <code>.env</code> injection</td></tr><tr><td>Feature Flags</td><td><code>github.com/open-feature/go-sdk</code> with Unleash provider</td></tr><tr><td>Circuit Breaker</td><td><code>github.com/sony/gobreaker</code></td></tr><tr><td>Retry / Backoff</td><td><code>github.com/cenkalti/backoff/v4</code></td></tr><tr><td>Actor lifecycle</td><td><code>github.com/oklog/run</code></td></tr></tbody></table><h2 id="user-scenarios-testing" tabindex="-1">User Scenarios &amp; Testing <a class="header-anchor" href="#user-scenarios-testing" aria-label="Permalink to &quot;User Scenarios &amp; Testing&quot;">​</a></h2><h3 id="p1-—-must-have" tabindex="-1">P1 — Must Have <a class="header-anchor" href="#p1-—-must-have" aria-label="Permalink to &quot;P1 — Must Have&quot;">​</a></h3><p><strong>US-1</strong>: As a platform operator, I want <code>POST /api/v1/bootstrap</code> via Heimdall to provision all infra and return a phase-by-phase result.</p><ul><li><strong>Given</strong>: Cortex is running; all four infra services are reachable</li><li><strong>When</strong>: <code>POST /api/v1/bootstrap</code></li><li><strong>Then</strong>: <code>200 {&quot;status&quot;:&quot;ok&quot;,&quot;phases&quot;:{&quot;postgres&quot;:&quot;ok&quot;,&quot;nats&quot;:&quot;ok&quot;,&quot;pulsar&quot;:&quot;ok&quot;,&quot;redis&quot;:&quot;ok&quot;}}</code>; NATS streams and Pulsar topics exist</li><li><strong>Test</strong>: <code>curl -X POST http://localhost:8081/api/v1/bootstrap</code>; then <code>nats stream ls</code> and <code>pulsar-admin topics list</code></li></ul><p><strong>US-2</strong>: As Heimdall, I want <code>GET /health</code> to return 200 immediately at startup so the gateway can route traffic before bootstrap completes.</p><ul><li><strong>Given</strong>: Cortex container starts with valid config</li><li><strong>When</strong>: <code>GET /health</code> (within 1s of container start)</li><li><strong>Then</strong>: <code>200 {&quot;status&quot;:&quot;healthy&quot;,&quot;mode&quot;:&quot;shallow&quot;}</code></li><li><strong>Test</strong>: <code>curl -sf http://localhost:8081/health</code> immediately after <code>docker compose up cortex</code></li></ul><p><strong>US-3</strong>: As a platform operator, I want <code>GET /health/deep</code> to call <code>RunDeepHealth()</code> and return per-dependency probe results.</p><ul><li><strong>Given</strong>: arc-sql-db is down; others healthy</li><li><strong>When</strong>: <code>GET /health/deep</code></li><li><strong>Then</strong>: <code>503 {&quot;status&quot;:&quot;unhealthy&quot;,&quot;dependencies&quot;:{&quot;arc-sql-db&quot;:{&quot;ok&quot;:false,&quot;latencyMs&quot;:...,&quot;error&quot;:&quot;...&quot;},...}}</code></li><li><strong>Test</strong>: Stop arc-sql-db; call <code>/health/deep</code>; assert 503 with oracle unhealthy entry</li></ul><p><strong>US-4</strong>: As the platform runtime, I want <code>GET /ready</code> to gate dependent services — 503 while bootstrap runs, 200 after.</p><ul><li><strong>Given</strong>: Bootstrap is in progress</li><li><strong>When</strong>: <code>GET /ready</code></li><li><strong>Then</strong>: <code>503 {&quot;ready&quot;:false}</code>; after all phases succeed → <code>200 {&quot;ready&quot;:true}</code></li><li><strong>Test</strong>: Poll <code>/ready</code> during startup; assert state transitions</li></ul><p><strong>US-5</strong>: As a platform operator, I want NATS streams provisioned with exact config so agents have messaging infrastructure.</p><ul><li><strong>Given</strong>: <code>arc-messaging</code> at <code>nats://arc-messaging:4222</code></li><li><strong>When</strong>: Bootstrap Phase 2 completes</li><li><strong>Then</strong>: Three streams with exact subjects and retention (see FR-4)</li><li><strong>Test</strong>: <code>nats stream info AGENT_COMMANDS</code> confirms subjects, retention, max-age</li></ul><p><strong>US-6</strong>: As a platform operator, I want <code>cortex bootstrap</code> (CLI) to run the same bootstrap and exit 0.</p><ul><li><strong>Given</strong>: All infra services are running</li><li><strong>When</strong>: <code>docker run arc-cortex bootstrap</code></li><li><strong>Then</strong>: Exit code 0; same provisioning as HTTP trigger; OTEL span emitted</li><li><strong>Test</strong>: <code>docker run arc-cortex bootstrap; echo $?</code></li></ul><h3 id="p2-—-should-have" tabindex="-1">P2 — Should Have <a class="header-anchor" href="#p2-—-should-have" aria-label="Permalink to &quot;P2 — Should Have&quot;">​</a></h3><p><strong>US-7</strong>: As a platform operator, I want bootstrap phases to retry with exponential backoff so transient infra gaps don&#39;t fail permanently.</p><ul><li><strong>Given</strong>: arc-messaging is temporarily unreachable</li><li><strong>When</strong>: Phase 2 executes</li><li><strong>Then</strong>: Retries 2s→30s backoff, up to 5 min; succeeds once arc-messaging comes online</li><li><strong>Test</strong>: Start Cortex before arc-messaging; bring arc-messaging up within 2 min; verify streams created</li></ul><p><strong>US-8</strong>: As a platform SRE, I want client calls protected by circuit breakers so a flapping dep doesn&#39;t stall the service.</p><ul><li><strong>Given</strong>: A dep fails 3 consecutive times</li><li><strong>When</strong>: 4th attempt occurs</li><li><strong>Then</strong>: Circuit open; fast-fails with <code>ErrCircuitOpen</code>; resets after 30s</li><li><strong>Test</strong>: Unit test — mock client to fail 3×; assert 4th call returns immediately</li></ul><p><strong>US-9</strong>: As a platform SRE, I want OTEL traces and metrics exported to arc-friday so bootstrap visibility is built-in.</p><ul><li><strong>Given</strong>: <code>arc-friday-collector</code> running on <code>:4317</code></li><li><strong>When</strong>: Bootstrap runs</li><li><strong>Then</strong>: Traces in arc-friday under <code>arc-cortex</code>; <code>cortex.bootstrap.phase_duration_seconds</code> metric per phase</li><li><strong>Test</strong>: <code>make otel-up &amp;&amp; docker compose up cortex</code>; check arc-friday UI</li></ul><p><strong>US-10</strong>: As a platform operator, I want secrets (DB password, Redis auth) fetched from Infisical (Nick Fury) so credentials are never baked into config files or env vars.</p><ul><li><strong>Given</strong>: Nick Fury (Infisical) is running and Cortex has a service token</li><li><strong>When</strong>: Cortex starts and <code>config.Load()</code> runs</li><li><strong>Then</strong>: Postgres password and Redis password come from Infisical; no plaintext secrets in container env</li><li><strong>Test</strong>: Set <code>INFISICAL_TOKEN</code>; verify Cortex connects to Postgres without <code>POSTGRES_PASSWORD</code> env var</li></ul><h3 id="p3-—-nice-to-have" tabindex="-1">P3 — Nice to Have <a class="header-anchor" href="#p3-—-nice-to-have" aria-label="Permalink to &quot;P3 — Nice to Have&quot;">​</a></h3><p><strong>US-11</strong>: As a platform operator, I want feature flags (via Unleash/Mystique) to control which bootstrap phases run so I can toggle phases without redeploying.</p><ul><li><strong>Given</strong>: Mystique (Unleash) is running; flag <code>cortex.bootstrap.pulsar.enabled</code> is <code>false</code></li><li><strong>When</strong>: Bootstrap runs</li><li><strong>Then</strong>: Phase 3 (Pulsar) is skipped; other phases run normally</li><li><strong>Test</strong>: Disable Pulsar flag in Unleash; call <code>/api/v1/bootstrap</code>; confirm no Pulsar provisioning and 200 response</li></ul><p><strong>US-12</strong>: As a platform operator, I want dependency health monitored every 30s post-bootstrap so drift is detected automatically.</p><ul><li><strong>Given</strong>: Cortex is running; arc-cache goes down after bootstrap</li><li><strong>When</strong>: 30s monitoring cycle runs</li><li><strong>Then</strong>: Degraded state logged with slog; <code>/health/deep</code> reflects it</li><li><strong>Test</strong>: Kill arc-cache post-bootstrap; wait 30s; check logs and <code>/health/deep</code></li></ul><h2 id="requirements" tabindex="-1">Requirements <a class="header-anchor" href="#requirements" aria-label="Permalink to &quot;Requirements&quot;">​</a></h2><h3 id="functional" tabindex="-1">Functional <a class="header-anchor" href="#functional" aria-label="Permalink to &quot;Functional&quot;">​</a></h3><ul><li>[ ] FR-1: Expose two Cobra commands: <code>cortex server</code> (primary — start Gin API) and <code>cortex bootstrap</code> (secondary — one-shot CLI)</li><li>[ ] FR-2: Gin API routes: <code>POST /api/v1/bootstrap</code>, <code>GET /health</code>, <code>GET /health/deep</code>, <code>GET /ready</code></li><li>[ ] FR-3: Middleware chain on all routes: <code>Recovery</code> → <code>FridayOTEL</code> (otelgin, service name <code>arc-cortex</code>) → <code>RequestLogger</code></li><li>[ ] FR-4: Bootstrap Phase 1 — Postgres: <code>Ping</code> + <code>ValidateSchema(&quot;public&quot;)</code> via pgx pool; host <code>arc-sql-db:5432</code></li><li>[ ] FR-5: Bootstrap Phase 2 — NATS JetStream on <code>arc-messaging:4222</code>: <ul><li><code>AGENT_COMMANDS</code> — subjects <code>[&quot;agent.*.cmd&quot;]</code>, retention <code>limits</code>, max-age <code>24h</code></li><li><code>AGENT_EVENTS</code> — subjects <code>[&quot;agent.*.event&quot;,&quot;agent.*.status&quot;]</code>, retention <code>interest</code>, max-age <code>168h</code></li><li><code>SYSTEM_METRICS</code> — subjects <code>[&quot;metrics.&gt;&quot;]</code>, retention <code>limits</code>, max-age <code>6h</code></li></ul></li><li>[ ] FR-6: Bootstrap Phase 3 — Pulsar on <code>arc-streaming:8080</code>: <ul><li>Tenant: <code>arc-system</code></li><li>Namespaces: <code>events</code>, <code>logs</code>, <code>audit</code></li><li>Topics: <code>persistent://arc-system/events/agent-lifecycle</code> (3 partitions), <code>persistent://arc-system/logs/application</code> (4 partitions), <code>persistent://arc-system/audit/command-log</code> (1 partition)</li></ul></li><li>[ ] FR-7: Bootstrap Phase 4 — Redis <code>PING</code> to <code>arc-cache:6379</code></li><li>[ ] FR-8: All four phases run in parallel (via goroutines); each retries independently — exponential backoff initial <code>2s</code>, max interval <code>30s</code>, max elapsed <code>5m</code></li><li>[ ] FR-9: Stream and topic creation is idempotent — safe to call multiple times</li><li>[ ] FR-10: All infra clients wrapped with circuit breaker: open after 3 failures, reset after 30s; return <code>ErrCircuitOpen</code> when open</li><li>[ ] FR-11: Config loaded via <code>config.Load()</code> using Viper — YAML file + env vars (env vars override); secrets fetched from Infisical if <code>INFISICAL_TOKEN</code> is set, otherwise falls back to env vars</li><li>[ ] FR-12: <code>GET /health/deep</code> calls <code>orchestrator.RunDeepHealth(ctx)</code> — concurrent TCP/HTTP probes per dep; returns <code>ProbeResult{Name, OK, LatencyMs, Error}</code> per dep; <code>503</code> if any fail</li><li>[ ] FR-13: <code>GET /ready</code> — <code>503</code> while bootstrap is in progress; <code>200</code> once <code>RunBootstrap()</code> returns without error</li><li>[ ] FR-14: <code>POST /api/v1/bootstrap</code> returns <code>409</code> if bootstrap is already in progress (atomic state guard)</li><li>[ ] FR-15: (P3) Feature flag check via <code>open-feature/go-sdk</code> (Unleash provider) before each phase; if flag <code>cortex.bootstrap.&lt;phase&gt;.enabled</code> is <code>false</code>, skip phase and mark as <code>skipped</code> in result</li></ul><h3 id="non-functional" tabindex="-1">Non-Functional <a class="header-anchor" href="#non-functional" aria-label="Permalink to &quot;Non-Functional&quot;">​</a></h3><ul><li>[ ] NFR-1: OTEL traces + metrics → <code>arc-widow:4317</code> gRPC; service name <code>arc-cortex</code>; namespace <code>arc</code>; 100% sampling</li><li>[ ] NFR-2: Container runs as non-root user (<code>USER cortex</code> in Dockerfile)</li><li>[ ] NFR-3: No secrets in logs, stack traces, or HTTP error bodies; Infisical token never logged</li><li>[ ] NFR-4: <code>GET /health</code> &lt; 50ms; <code>GET /health/deep</code> &lt; 5s (concurrent probes, 5s timeout each)</li><li>[ ] NFR-5: Graceful shutdown ≤ 30s; active bootstrap phase given 30s grace before context cancel</li><li>[ ] NFR-6: <code>golangci-lint run</code> passes with zero errors</li><li>[ ] NFR-7: <code>go test ./...</code> ≥ 75% coverage on <code>internal/orchestrator</code> and <code>internal/clients</code>; ≥ 60% on <code>internal/api</code></li></ul><h3 id="key-entities" tabindex="-1">Key Entities <a class="header-anchor" href="#key-entities" aria-label="Permalink to &quot;Key Entities&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Entity</th><th>Path</th><th>Description</th></tr></thead><tbody><tr><td><code>Orchestrator</code></td><td><code>internal/orchestrator/service.go</code></td><td><code>RunBootstrap(ctx) BootstrapResult</code>, <code>RunDeepHealth(ctx) map[string]ProbeResult</code></td></tr><tr><td><code>BootstrapResult</code></td><td><code>internal/orchestrator/types.go</code></td><td><code>{Status, Phases map[string]PhaseResult}</code> returned to HTTP handler and CLI</td></tr><tr><td><code>PhaseResult</code></td><td><code>internal/orchestrator/types.go</code></td><td><code>{Name, Status, Error}</code> — one per phase</td></tr><tr><td><code>ProbeResult</code></td><td><code>internal/orchestrator/types.go</code></td><td><code>{Name, OK, LatencyMs, Error}</code> — one per dep in deep health</td></tr><tr><td><code>Config</code></td><td><code>internal/config/config.go</code></td><td>Root Viper/Infisical config; <code>Load(path string) (*Config, error)</code></td></tr><tr><td><code>ServerConfig</code></td><td><code>internal/config/config.go</code></td><td><code>SERVER_PORT</code> (8081), timeouts</td></tr><tr><td><code>TelemetryConfig</code></td><td><code>internal/config/config.go</code></td><td><code>TELEMETRY_OTLP_ENDPOINT</code>, service name, log level</td></tr><tr><td><code>NATSConfig</code> / <code>StreamConfig</code></td><td><code>internal/config/config.go</code></td><td>NATS URL + stream definitions</td></tr><tr><td><code>PulsarConfig</code> / <code>TopicConfig</code></td><td><code>internal/config/config.go</code></td><td>Pulsar URLs, tenant, namespaces, topics</td></tr><tr><td><code>PostgresConfig</code></td><td><code>internal/config/config.go</code></td><td>pgx pool — host, port, user, db, ssl, pool size</td></tr><tr><td><code>RedisConfig</code></td><td><code>internal/config/config.go</code></td><td>go-redis — host, port, db, password (from Infisical)</td></tr><tr><td><code>Metrics</code></td><td><code>internal/telemetry/friday.go</code></td><td>OTEL metric instruments: phase duration histograms, error counters, HTTP request metrics</td></tr></tbody></table><h3 id="key-environment-variables" tabindex="-1">Key Environment Variables <a class="header-anchor" href="#key-environment-variables" aria-label="Permalink to &quot;Key Environment Variables&quot;">​</a></h3><table tabindex="0"><thead><tr><th>Env Var</th><th>Default</th><th>Description</th></tr></thead><tbody><tr><td><code>SERVER_PORT</code></td><td><code>8081</code></td><td>HTTP listen port</td></tr><tr><td><code>SERVER_SHUTDOWN_TIMEOUT</code></td><td><code>30s</code></td><td>Graceful shutdown budget</td></tr><tr><td><code>TELEMETRY_OTLP_ENDPOINT</code></td><td><code>arc-widow:4317</code></td><td>OTEL collector gRPC address</td></tr><tr><td><code>TELEMETRY_OTLP_INSECURE</code></td><td><code>true</code></td><td>Skip TLS for OTLP (dev)</td></tr><tr><td><code>TELEMETRY_SERVICE_NAME</code></td><td><code>arc-cortex</code></td><td>OTEL service name</td></tr><tr><td><code>TELEMETRY_LOG_LEVEL</code></td><td><code>info</code></td><td><code>debug|info|warn|error</code></td></tr><tr><td><code>BOOTSTRAP_TIMEOUT</code></td><td><code>5m</code></td><td>Max elapsed time per phase</td></tr><tr><td><code>BOOTSTRAP_RETRY_BACKOFF</code></td><td><code>2s</code></td><td>Initial backoff interval</td></tr><tr><td><code>NATS_URL</code></td><td><code>nats://arc-messaging:4222</code></td><td>NATS connection URL</td></tr><tr><td><code>PULSAR_ADMIN_URL</code></td><td><code>http://arc-streaming:8080</code></td><td>Pulsar admin REST API</td></tr><tr><td><code>PULSAR_SERVICE_URL</code></td><td><code>pulsar://arc-streaming:6650</code></td><td>Pulsar binary protocol</td></tr><tr><td><code>PULSAR_TENANT</code></td><td><code>arc-system</code></td><td>Pulsar tenant to provision</td></tr><tr><td><code>POSTGRES_HOST</code></td><td><code>arc-sql-db</code></td><td>Postgres host</td></tr><tr><td><code>POSTGRES_PORT</code></td><td><code>5432</code></td><td>Postgres port</td></tr><tr><td><code>POSTGRES_USER</code></td><td><code>arc</code></td><td>Postgres user</td></tr><tr><td><code>POSTGRES_DB</code></td><td><code>arc_db</code></td><td>Database name</td></tr><tr><td><code>POSTGRES_SSL_MODE</code></td><td><code>disable</code></td><td><code>disable|require|verify-full</code></td></tr><tr><td><code>REDIS_HOST</code></td><td><code>arc-cache</code></td><td>Redis host</td></tr><tr><td><code>REDIS_PORT</code></td><td><code>6379</code></td><td>Redis port</td></tr><tr><td><code>INFISICAL_TOKEN</code></td><td>—</td><td>If set, secrets fetched from Nick Fury (Infisical)</td></tr><tr><td><code>UNLEASH_URL</code></td><td>—</td><td>If set, feature flags fetched from Mystique (Unleash)</td></tr></tbody></table><h2 id="edge-cases" tabindex="-1">Edge Cases <a class="header-anchor" href="#edge-cases" aria-label="Permalink to &quot;Edge Cases&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Scenario</th><th>Expected Behavior</th></tr></thead><tbody><tr><td>Dep unreachable at startup</td><td>Phase retries for up to 5 min; <code>/health</code> stays 200; <code>/ready</code> stays 503</td></tr><tr><td><code>arc-friday-collector</code> unreachable</td><td>OTEL SDK buffers silently; no impact on bootstrap or HTTP</td></tr><tr><td><code>POST /api/v1/bootstrap</code> while already running</td><td><code>409 {&quot;status&quot;:&quot;in-progress&quot;}</code></td></tr><tr><td>NATS stream already exists</td><td><code>CreateStream</code> idempotent — updates config if changed, no error</td></tr><tr><td>Pulsar topic already exists</td><td>Topic creation skipped; no error</td></tr><tr><td>Infisical unreachable at start</td><td>Fall back to env var secrets; log warning; proceed normally</td></tr><tr><td>Unleash unreachable</td><td>Feature flags default to <code>true</code> (all phases enabled); log warning</td></tr><tr><td><code>cortex bootstrap</code> exits non-zero</td><td>Exit code 1 + JSON error to stdout (<code>{&quot;status&quot;:&quot;error&quot;,&quot;phase&quot;:&quot;...&quot;,&quot;error&quot;:&quot;...&quot;}</code>)</td></tr><tr><td>Panic in HTTP handler</td><td><code>Recovery</code> middleware catches; logs stack; <code>500</code>; service continues</td></tr><tr><td><code>SIGTERM</code> during active phase</td><td>Phase gets 30s grace; context cancelled after; server shuts down</td></tr><tr><td>Postgres password missing (no Infisical)</td><td><code>config.Load()</code> validation fails; service exits with descriptive error</td></tr><tr><td>Circuit breaker open</td><td>Client calls return <code>ErrCircuitOpen</code> immediately; retries resume when circuit resets (30s)</td></tr></tbody></table><h2 id="success-criteria" tabindex="-1">Success Criteria <a class="header-anchor" href="#success-criteria" aria-label="Permalink to &quot;Success Criteria&quot;">​</a></h2><ul><li>[ ] SC-1: <code>docker compose up cortex</code> — <code>/health</code> returns 200 within 3s of start</li><li>[ ] SC-2: <code>POST /api/v1/bootstrap</code> with all four infra services running → 200; <code>nats stream ls</code> shows 3 streams; Pulsar shows <code>arc-system</code> tenant</li><li>[ ] SC-3: <code>cortex bootstrap</code> CLI exits 0 and provisions identical infra as the HTTP trigger</li><li>[ ] SC-4: <code>make otel-up &amp;&amp; docker compose up cortex</code> — traces visible in arc-friday under service <code>arc-cortex</code>; phase duration metrics exported</li><li>[ ] SC-5: <code>go test ./...</code> passes ≥ 75% coverage on orchestrator and client packages</li><li>[ ] SC-6: <code>golangci-lint run</code> — zero errors</li><li>[ ] SC-7: <code>docker inspect arc-cortex</code> — non-root user confirmed</li></ul><h2 id="docs-links-update" tabindex="-1">Docs &amp; Links Update <a class="header-anchor" href="#docs-links-update" aria-label="Permalink to &quot;Docs &amp; Links Update&quot;">​</a></h2><ul><li>[ ] Update <code>.specify/config.yaml</code> — change <code>dir: &quot;bootstrap&quot;, codename: &quot;raymond&quot;</code> → <code>dir: &quot;cortex&quot;, codename: &quot;cortex&quot;</code></li><li>[ ] Update <code>services/profiles.yaml</code> — include <code>cortex</code> in <code>think</code> and <code>reason</code> profiles</li><li>[ ] Add <code>services/cortex/service.yaml</code> — <code>codename: cortex</code>, <code>depends_on: [flash, strange, oracle, sonic, widow]</code>, <code>health: http://localhost:8081/health</code></li><li>[ ] Add <code>services/cortex/README.md</code> — quickstart, env var table, example <code>docker compose</code> snippet</li><li>[ ] Update <code>.specify/meta/service-codename-map.md</code> — add Cortex entry</li><li>[ ] Update <code>.specify/docs/architecture/cortex.md</code> — link to <code>services/cortex/</code> implementation once built</li></ul><h2 id="constitution-compliance" tabindex="-1">Constitution Compliance <a class="header-anchor" href="#constitution-compliance" aria-label="Permalink to &quot;Constitution Compliance&quot;">​</a></h2><table tabindex="0"><thead><tr><th>Principle</th><th>Applies</th><th>Compliant</th><th>Notes</th></tr></thead><tbody><tr><td>I. Zero-Dep CLI</td><td>[ ]</td><td>[n/a]</td><td>Service, not CLI binary</td></tr><tr><td>II. Platform-in-a-Box</td><td>[x]</td><td>[x]</td><td><code>docker compose up</code> provisions all infra; no manual wiring</td></tr><tr><td>III. Modular Services</td><td>[x]</td><td>[x]</td><td>Self-contained in <code>services/cortex/</code>; <code>service.yaml</code> declares all deps</td></tr><tr><td>IV. Two-Brain</td><td>[x]</td><td>[x]</td><td>Pure Go — infrastructure domain only</td></tr><tr><td>V. Polyglot Standards</td><td>[x]</td><td>[x]</td><td>golangci-lint, slog, table-driven tests, 12-factor config</td></tr><tr><td>VI. Local-First</td><td>[ ]</td><td>[n/a]</td><td>Service, not CLI</td></tr><tr><td>VII. Observability</td><td>[x]</td><td>[x]</td><td>OTEL traces + metrics from day one; <code>/health</code> + <code>/health/deep</code>; span per phase</td></tr><tr><td>VIII. Security</td><td>[x]</td><td>[x]</td><td>Non-root container; secrets via Infisical, not env; nothing sensitive in logs</td></tr><tr><td>IX. Declarative</td><td>[ ]</td><td>[n/a]</td><td>Service, not reconciler</td></tr><tr><td>X. Stateful Ops</td><td>[ ]</td><td>[n/a]</td><td>Service, not CLI</td></tr><tr><td>XI. Resilience</td><td>[x]</td><td>[x]</td><td>Circuit breakers + exponential backoff on all four infra clients</td></tr><tr><td>XII. Interactive</td><td>[ ]</td><td>[n/a]</td><td>Service, not CLI TUI</td></tr></tbody></table><p>&lt;NolebaseGitContributors /&gt;</p><p>&lt;NolebaseGitChangelog /&gt;</p>',50))])}const C=i(u,[["render",h]]);export{A as __pageData,C as default};
