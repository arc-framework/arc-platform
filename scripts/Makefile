# â”€â”€â”€ A.R.C. Scripts â€” Makefile â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# Runner and validation for scripts/ utilities.
# All targets use common.sh conventions (dry-run default, structured logging).
#
# Usage:
#   make help               Show available targets
#   make packages-list      Preview packages (dry-run)
#   make check              Syntax + shellcheck validation
#   make packages-delete ORG=my-org
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

SCRIPTS_DIR := $(dir $(abspath $(lastword $(MAKEFILE_LIST))))

ORG ?= arc-framework

.PHONY: help \
        packages-list packages-list-json packages-delete \
        check check-syntax check-lint \
        list permissions

# â”€â”€â”€ Help â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## help: Show available targets
help:
	@echo ""
	@echo "  ðŸ“¦ scripts/Makefile â€” A.R.C. script runner"
	@echo ""
	@grep -E '^## [a-z].*:' $(MAKEFILE_LIST) | sed 's/## /  /'
	@echo ""

# â”€â”€â”€ Packages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## packages-list: ðŸ“‹ Preview container packages for an org (dry-run)
packages-list:
	@$(SCRIPTS_DIR)/delete-org-packages.sh $(ORG)

## packages-list-json: ðŸ“‹ Preview packages in JSON-lines format
packages-list-json:
	@$(SCRIPTS_DIR)/delete-org-packages.sh --json $(ORG)

## packages-delete: ðŸ—‘ï¸  Delete all container packages (requires safety gates)
## Override: make packages-delete ORG=my-org
packages-delete:
	@ARC_CONFIRM_DESTRUCTIVE=1 $(SCRIPTS_DIR)/delete-org-packages.sh --no-dry-run $(ORG)

# â”€â”€â”€ Validation â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## check: ðŸ” Run all validations (syntax + shellcheck)
check: check-syntax check-lint

## check-syntax: ðŸ” Verify bash syntax for all scripts
check-syntax:
	@echo "Checking bash syntax..."
	@fail=0; \
	for f in $(SCRIPTS_DIR)/*.sh $(SCRIPTS_DIR)/lib/*.sh; do \
		if bash -n "$$f" 2>/dev/null; then \
			echo "  âœ“ $$(basename $$f)"; \
		else \
			echo "  âœ— $$(basename $$f)"; fail=1; \
		fi; \
	done; \
	[ $$fail -eq 0 ] && echo "âœ“ All files OK" || exit 1

## check-lint: ðŸ” Run shellcheck (skips if not installed)
check-lint:
	@if command -v shellcheck >/dev/null 2>&1; then \
		echo "Running shellcheck..."; \
		shellcheck -x $(SCRIPTS_DIR)/*.sh $(SCRIPTS_DIR)/lib/*.sh \
			&& echo "âœ“ shellcheck passed" \
			|| { echo "âœ— shellcheck found issues"; exit 1; }; \
	else \
		echo "âš  shellcheck not installed â€” skipping (brew install shellcheck)"; \
	fi

# â”€â”€â”€ Utilities â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

## list: ðŸ“„ Show all scripts with descriptions
list:
	@echo ""
	@echo "  Available scripts:"
	@echo ""
	@for f in $(SCRIPTS_DIR)/*.sh; do \
		name=$$(basename "$$f"); \
		desc=$$($$f --help 2>/dev/null | sed -n '3p' | sed 's/^ *//' || echo "(no description)"); \
		printf '    %-30s %s\n' "$$name" "$$desc"; \
	done
	@echo ""

## permissions: ðŸ”§ Ensure all scripts are executable
permissions:
	@chmod +x $(SCRIPTS_DIR)/*.sh $(SCRIPTS_DIR)/lib/*.sh
	@echo "âœ“ All scripts are executable"
